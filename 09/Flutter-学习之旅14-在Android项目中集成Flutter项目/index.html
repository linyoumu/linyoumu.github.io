<!DOCTYPE html>
<html lang="en">
    <head>
  <!-- 元数据 -->
  <meta charset="utf-8">
  
  
  <title>Flutter 学习之旅14 在Android项目中集成Flutter项目 | 欢迎来到我的个人博客</title>
  <meta name="author" content="勿忘初心" />
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="robots" content="index,follow" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="format-detection" content="telphone=no, email=no" />
  
    <meta name="keywords" content="" />
  
  <meta name="description" content="在 Android 项目中集成 Flutter 项目首先我们需要找一个 android 项目，以这个为基础来集成 Fluuter。下面来看一下具体的步骤 创建 flutter 模块 在 AndroidStudio 的 Terminal 中使用如下命令： 1flutter create -t module flutter_module  其中 flutter_module 为模块名称。该命令完成后将">
<meta property="og:type" content="article">
<meta property="og:title" content="Flutter 学习之旅14 在Android项目中集成Flutter项目">
<meta property="og:url" content="http://example.com/09/Flutter-%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%97%8514-%E5%9C%A8Android%E9%A1%B9%E7%9B%AE%E4%B8%AD%E9%9B%86%E6%88%90Flutter%E9%A1%B9%E7%9B%AE/index.html">
<meta property="og:site_name" content="欢迎来到我的个人博客">
<meta property="og:description" content="在 Android 项目中集成 Flutter 项目首先我们需要找一个 android 项目，以这个为基础来集成 Fluuter。下面来看一下具体的步骤 创建 flutter 模块 在 AndroidStudio 的 Terminal 中使用如下命令： 1flutter create -t module flutter_module  其中 flutter_module 为模块名称。该命令完成后将">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/flutter/k22ievwfwhuoo_6b9479a83d044290ba1e73f35e0fb2f1.png">
<meta property="og:image" content="http://example.com/images/flutter/k22ievwfwhuoo_3f26e9f0979240da8b631dc246ca1fbc.png">
<meta property="og:image" content="http://example.com/images/flutter/k22ievwfwhuoo_06145391f5dc4d6abc4a47c316e134f2.png">
<meta property="article:published_time" content="2021-10-09T08:34:59.000Z">
<meta property="article:modified_time" content="2023-04-09T07:55:29.059Z">
<meta property="article:author" content="勿忘初心">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/flutter/k22ievwfwhuoo_6b9479a83d044290ba1e73f35e0fb2f1.png">
  
  <!-- 站点验证相关 -->
  
    
    
    
  
  <!-- 样式表文件 -->
  <link rel="stylesheet" id="kratos-css" href="/css/kratosr.min.css" media="all"></script>
  
    <link rel="stylesheet" id="darkmode-css" href="/css/kr-color-dark.min.css" media="(prefers-color-scheme: dark)"></script>
    <script src="/js/kr-dark.min.js"></script>
  
  
    <link rel="stylesheet" id="highlight-css" href="/css/highlight/night-eighties.min.css" media="all"></script>
  
  
  <link rel="stylesheet" id="fontawe-css" href="/vendors/font-awesome@4.7.0/css/font-awesome.min.css" media="all"></script>
  <link rel="stylesheet" id="nprogress-css" href="/vendors/nprogress@0.2.0/nprogress.css" media="all"></script>
  
  
    <link rel="stylesheet" href="/vendors/aplayer@1.10.1/dist/APlayer.min.css"></script>
  
  
    <link rel="stylesheet" href="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"></script>
  
  <!-- 不得不预先加载的一些JS文件 -->
  <script src="/vendors/jquery@3.6.0/dist/jquery.min.js"></script>
  
    <script src="/vendors/qrcode_js@1.0.0/qrcode.min.js"></script>
  
  
  <style>
    
      .kratos-cover.kratos-cover-2 {
        background-image: url('/images/banner.webp');
      }
    
    
      @media(min-width:768px) {
        body.custom-background {
          background-image: url('/images/bg.webp');
        }
      }
    
  </style>
  
<meta name="generator" content="Hexo 6.3.0"></head>


    <body class="custom-background">
        <div id="kratos-wrapper">
    <div id="kratos-page">
        <div id="kratos-header">
            <header id="kratos-desktop-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="nav-header">
                        <nav id="kratos-menu-wrap">
                            <ul id="kratos-primary-menu" class="sf-menu">
                                
                                    
                                    
                                
                            </ul>
                        </nav>
                    </div>
                </div>
            </header>
            <header id="kratos-mobile-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="color-logo"><a href="/">欢迎来到我的个人博客</a></div>
                    <div class="nav-toggle">
                        <a class="kratos-nav-toggle js-kratos-nav-toggle">
                            <i></i>
                        </a>
                    </div>
                </div>
            </header>
        </div>
        <div class="kratos-start kratos-hero-2">
            <!-- <div class="kratos-overlay"></div> -->
            <div class="kratos-cover kratos-cover-2 text-center">
                <div class="desc desc2 animate-box">
                    <a href="/">
                        <h2>欢迎来到我的个人博客</h2> <br />
                        <span></span>
                    </a>
                </div>
            </div>
        </div>

        <div id="kratos-blog-post">
            <div class="container">
                <div id="main" class="row">
                    

        

            <section class="col-md-8">

        

            <article itemscope itemtype="https://schema.org/Article">
    
    <link itemprop="mainEntityOfPage" href="http://example.com/09/Flutter-%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%97%8514-%E5%9C%A8Android%E9%A1%B9%E7%9B%AE%E4%B8%AD%E9%9B%86%E6%88%90Flutter%E9%A1%B9%E7%9B%AE/">
    <div class="kratos-hentry kratos-post-inner clearfix">
        <header class="kratos-entry-header">
            
                <h1 class="kratos-entry-title text-center" itemprop="name headline">Flutter 学习之旅14 在Android项目中集成Flutter项目</h1>
            
            
            <ul class="kratos-post-meta text-center">
                <li><time datetime="2021-10-09T08:34:59.000Z" itemprop="datePublished"><i class="fa fa-calendar"></i> 2021-10-09</time></li>
                <li itemprop="author" itemscope itemtype="https://schema.org/Person">
                    <i class="fa fa-user"></i> 作者 <span itemprop="name">勿忘初心</span>
                </li>
                <li>
                    <i class="fa fa-edit"></i> 
                    
                    
                        ~16.20K
                    
                    字
                </li>
                
            </ul>
        </header>
        <div class="kratos-post-content">
            
            <div id="expire-alert" class="alert alert-warning hidden" role="alert">
                <div class="icon"><i class="fa fa-warning"></i></div>
                <div class="text"><p>本文最后编辑于 <time datetime="1681026929059"></time> 前，其中的内容可能需要更新。</p></div>
            </div>
            
            
            
            <hr />
            <div itemprop="articleBody"><h2 id="在-Android-项目中集成-Flutter-项目"><a href="#在-Android-项目中集成-Flutter-项目" class="headerlink" title="在 Android 项目中集成 Flutter 项目"></a>在 Android 项目中集成 Flutter 项目</h2><p>首先我们需要找一个 android 项目，以这个为基础来集成 Fluuter。下面来看一下具体的步骤</p>
<p>创建 flutter 模块</p>
<p>在 AndroidStudio 的 Terminal 中使用如下命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flutter create -t module flutter_module</span><br></pre></td></tr></table></figure>

<p>其中 flutter_module 为模块名称。该命令完成后将会在项目目录中产生一个新的文件夹 flutter_module</p>
<p>或者直接使用 AS 创建一个 Flutter Module也行。</p>
<p>将 两个项目放在一个文件夹下面，这一步主要是为了方便管理，并且可以分开上传到 git，方便开发等。不在一个目录下也行。</p>
<p>执行 flutter build aar</p>
<p>打开 Flutter 模块，执行 flutter build aar 命令。</p>
<p>上面的四个项目都需要在 android 代码中完成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">repositories &#123;</span><br><span class="line">   //...    </span><br><span class="line">    maven &#123; url &#x27;D:\\android\\project\\example\\flutter_module\\build\\host\\outputs\\repo&#x27; &#125;</span><br><span class="line">    maven &#123; url &quot;https://storage.googleapis.com/download.flutter.io&quot; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新项目的 repositories 都需要配置在 setting.gradle 中。</p>
<p>上面中的 url 就是 fluuter_modlue 的路径了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    //..... </span><br><span class="line">    debugImplementation &#x27;com.lv.example.flutter_module:flutter_debug:1.0&#x27;</span><br><span class="line">    profileImplementation &#x27;com.lv.example.flutter_module:flutter_profile:1.0&#x27;</span><br><span class="line">    releaseImplementation &#x27;com.lv.example.flutter_module:flutter_release:1.0&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">buildTypes &#123;</span><br><span class="line">    profile &#123;</span><br><span class="line">        initWith debug</span><br><span class="line">    &#125;</span><br><span class="line">    release &#123;</span><br><span class="line">        minifyEnabled false</span><br><span class="line">        proguardFiles getDefaultProguardFile(&#x27;proguard-android-optimize.txt&#x27;), &#x27;proguard-rules.pro&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同步项目</p>
<p>同步一下项目，看有没有报错，如果有排查一下问题</p>
<p>添加 FlutterActivity</p>
<p>在 AdnroidManifest.xml 中添加 FlutterActivity</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;activity</span><br><span class="line">    android:name=&quot;io.flutter.embedding.android.FlutterActivity&quot; android:configChanges=&quot;orientation|keyboardHidden|keyboard|screenSize|locale|layoutDirection|fontScale|screenLayout|density|uiMode&quot;</span><br><span class="line">    android:hardwareAccelerated=&quot;true&quot;</span><br><span class="line">    android:windowSoftInputMode=&quot;adjustResize&quot; /&gt;</span><br></pre></td></tr></table></figure>

<p>跳转</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">class MainActivity : AppCompatActivity() &#123;</span><br><span class="line">    override fun onCreate(savedInstanceState: Bundle?) &#123;</span><br><span class="line">        super.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_main)</span><br><span class="line">        findViewById&lt;View&gt;(R.id.start).setOnClickListener &#123;</span><br><span class="line">            startActivity(</span><br><span class="line">                FlutterActivity.createDefaultIntent(this)</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Flutter-和-Android-的交互"><a href="#Flutter-和-Android-的交互" class="headerlink" title="Flutter 和 Android 的交互"></a>Flutter 和 Android 的交互</h2><h3 id="Android-调起-Flutter-页面"><a href="#Android-调起-Flutter-页面" class="headerlink" title="Android 调起 Flutter 页面"></a>Android 调起 Flutter 页面</h3><p>在上面的代码中已经有打开 flutter 页面的代码了，如下所示：</p>
<p>startActivity(FlutterActivity.createDefaultIntent(this))</p>
<p>不过你运行代码，就会发现这种方式启动会非常慢，下面来看一种预初始化 Flutter 的方式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">class MainActivity : AppCompatActivity() &#123;</span><br><span class="line">    private val flutterEngine by lazy &#123; initFlutterEngine() &#125;;</span><br><span class="line">    override fun onCreate(savedInstanceState: Bundle?) &#123;</span><br><span class="line">     ...//</span><br><span class="line">        findViewById&lt;View&gt;(R.id.start).setOnClickListener &#123;</span><br><span class="line">            startActivity(</span><br><span class="line">                FlutterActivity.withCachedEngine(&quot;default_engine_id&quot;).build(this)</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    private fun initFlutterEngine(): FlutterEngine &#123;</span><br><span class="line">        //创建 Flutter 引擎</span><br><span class="line">        val flutterEngine = FlutterEngine(this)</span><br><span class="line">        //指定要跳转的flutter页面</span><br><span class="line">        flutterEngine.navigationChannel.setInitialRoute(&quot;main&quot;)</span><br><span class="line">        flutterEngine.dartExecutor.executeDartEntrypoint(DartExecutor.DartEntrypoint.createDefault())</span><br><span class="line">        //这里做一个缓存，可以在适当的时候执行它，例如app里，在跳转前执行预加载</span><br><span class="line">        val flutterEngineCache = FlutterEngineCache.getInstance();</span><br><span class="line">        flutterEngineCache.put(&quot;default_engine_id&quot;, flutterEngine)</span><br><span class="line">        //上面代码一般在跳转之前调用，这样可以使得跳转树的加快</span><br><span class="line">        return flutterEngine</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    override fun onDestroy() &#123;</span><br><span class="line">       super.onDestroy()</span><br><span class="line">       flutterEngine.destroy()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Flutter 代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">void main() =&gt; runApp(getRouter(window.defaultRouteName));</span><br><span class="line">Widget getRouter(String name) &#123;</span><br><span class="line">  switch (name) &#123;</span><br><span class="line">    case &quot;main&quot;:</span><br><span class="line">      return const MyApp();</span><br><span class="line">    default:</span><br><span class="line">      return MaterialApp(</span><br><span class="line">        title: &quot;Flutter Demo&quot;,</span><br><span class="line">        theme: ThemeData(</span><br><span class="line">          primarySwatch: Colors.blue,</span><br><span class="line">        ),</span><br><span class="line">        home: Container(</span><br><span class="line">          alignment: Alignment.center,</span><br><span class="line">          child: Text(&quot;not font page $name&#125;&quot;),</span><br><span class="line">        ),</span><br><span class="line">      );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以发现，跳转的速度明显加快了许多。</p>
<p>需要注意的是，并不是修改了 fluuter_model 中的代码后重新运行 android 后页面就会发生改变，在 android 项目中，flutter 的代码是一个 aar 包的形式存在的，所以 flutter 代码更新后，需要重新执行 flutter build aar 命令重新打一个aar 包才可以。</p>
<p>当然这并不是说每次都要这样操作，在正常开发过程中，直接运行 flutter_module 即可。等到需要合起来的时候执行该命令即可。</p>
<p>当使用缓存的 FlutterEngine 时，FlutterEngine 比任何显示它的 FlutterActivity 或 FlutterFragment 的寿命都要长。请记住，Dart 代码在您预热 FlutterEngine 后立即开始执行，并在您的 FlutterActivity&#x2F;FlutterFragment 销毁后继续执行。要停止执行并清除资源，请从 FlutterEngineCache 中获取 FlutterEngine 并使用 FlutterEngine.destroy() 销毁 FlutterEngine。</p>
<p>最后就是，如果要测试性能，请使用 release 版本</p>
<h3 id="携参跳转-Flutter"><a href="#携参跳转-Flutter" class="headerlink" title="携参跳转 Flutter"></a>携参跳转 Flutter</h3><p>如果在跳转的时候需要携带参数，只需要在 route 后面拼接上参数即可，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flutterEngine.navigationChannel.setInitialRoute(&quot;main?&#123;\&quot;name\&quot;:\&quot;345\&quot;&#125;&quot;)</span><br></pre></td></tr></table></figure>

<p>这里将路由和参数使用 ? 隔开，参数使用 json 格式进行传递。</p>
<p>在 Flutter 端通过 window.defaultRouteName 获取到的就是路由 + 参数了。我们只需要解析一下即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">String url = window.defaultRouteName;</span><br><span class="line">// route名称</span><br><span class="line">String route =</span><br><span class="line">    url.indexOf(&#x27;?&#x27;) == -1 ? url : url.substring(0, url.indexOf(&#x27;?&#x27;));</span><br><span class="line">// 参数Json字符串</span><br><span class="line">String paramsJson =</span><br><span class="line">    url.indexOf(&#x27;?&#x27;) == -1 ? &#x27;&#123;&#125;&#x27; : url.substring(url.indexOf(&#x27;?&#x27;) + 1);</span><br><span class="line">// 解析参数</span><br><span class="line">Map&lt;String, dynamic&gt; params = json.decode(paramsJson);</span><br></pre></td></tr></table></figure>

<p>通过上面代码即可拿到跳转的参数</p>
<h3 id="以透明的方式启动-FlutterActivity"><a href="#以透明的方式启动-FlutterActivity" class="headerlink" title="以透明的方式启动 FlutterActivity"></a>以透明的方式启动 FlutterActivity</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">startActivity(</span><br><span class="line">    FlutterActivity.withCachedEngine(&quot;default_engine_id&quot;)</span><br><span class="line">        .backgroundMode(FlutterActivityLaunchConfigs.BackgroundMode.transparent)</span><br><span class="line">        .build(this)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="以半透明的方式启动-FlutterActivity"><a href="#以半透明的方式启动-FlutterActivity" class="headerlink" title="以半透明的方式启动 FlutterActivity"></a>以半透明的方式启动 FlutterActivity</h3><p>1、需要一个主题属性，用于呈现半透明效果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;style name=&quot;MyTheme&quot; parent=&quot;@style/MyParentTheme&quot;&gt;</span><br><span class="line">  &lt;item name=&quot;android:windowIsTranslucent&quot;&gt;true&lt;/item&gt;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>2、将主题应用到 FlutterActivity 中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;activity</span><br><span class="line">  android:name=&quot;io.flutter.embedding.android.FlutterActivity&quot;</span><br><span class="line">  android:theme=&quot;@style/MyTheme&quot;</span><br><span class="line">  android:configChanges=&quot;orientation|keyboardHidden|keyboard|screenSize|locale|layoutDirection|fontScale|screenLayout|density|uiMode&quot;</span><br><span class="line">  android:hardwareAccelerated=&quot;true&quot;</span><br><span class="line">  android:windowSoftInputMode=&quot;adjustResize&quot;</span><br><span class="line">  /&gt;</span><br></pre></td></tr></table></figure>



<p>这样 FlutterActivity 即可支持半透明</p>
<h3 id="Android-嵌入-FlutterFragment"><a href="#Android-嵌入-FlutterFragment" class="headerlink" title="Android 嵌入 FlutterFragment"></a>Android 嵌入 FlutterFragment</h3><p>在 Android 页面中显示一个 FlutterFragment，基础操作如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">class MainActivity : AppCompatActivity() &#123;</span><br><span class="line">    //定义一个标记字符串来表示其中的FlutterFragment 活动的FragmentManager。这个值可以是你想要的任何值。</span><br><span class="line">    private val tagFlutterFragment = &quot;flutter_fragment&quot;</span><br><span class="line">    private var flutterFragment: FlutterFragment? = null</span><br><span class="line">    override fun onCreate(savedInstanceState: Bundle?) &#123;</span><br><span class="line">        super.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_main)</span><br><span class="line">        val flutterEngine = initFlutterEngine()</span><br><span class="line">        findViewById&lt;View&gt;(R.id.start).setOnClickListener &#123;</span><br><span class="line">            //尝试找到现有的FlutterFragment，以防这不是第一次运行onCreate()</span><br><span class="line">            flutterFragment =</span><br><span class="line">                supportFragmentManager.findFragmentByTag(tagFlutterFragment) as    FlutterFragment?</span><br><span class="line">            //创建 FlutterFragment</span><br><span class="line">            if (flutterFragment == null) flutterFragment =</span><br><span class="line">                FlutterFragment</span><br><span class="line">                    .withCachedEngine(&quot;default_engine_id&quot;)</span><br><span class="line">                    .build()</span><br><span class="line">            //加载 FlutterFragment</span><br><span class="line">            supportFragmentManager</span><br><span class="line">                .beginTransaction()</span><br><span class="line">                .add(R.id.layout, flutterFragment!!, tagFlutterFragment)</span><br><span class="line">                .commit()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    private fun initFlutterEngine(): FlutterEngine &#123;</span><br><span class="line">        //创建 Flutter 引擎</span><br><span class="line">        val flutterEngine = FlutterEngine(this)</span><br><span class="line">        //指定要跳转的flutter页面</span><br><span class="line">        flutterEngine.navigationChannel.setInitialRoute(&quot;main&quot;)</span><br><span class="line">        flutterEngine.dartExecutor.executeDartEntrypoint(DartExecutor.DartEntrypoint.createDefault())</span><br><span class="line">        //这里做一个缓存，可以在适当的时候执行它，例如app里，在跳转前执行预加载</span><br><span class="line">        val flutterEngineCache = FlutterEngineCache.getInstance();</span><br><span class="line">        flutterEngineCache.put(&quot;default_engine_id&quot;, flutterEngine)</span><br><span class="line">        //上面代码一般在跳转之前调用，这样可以使得跳转树的加快</span><br><span class="line">        return flutterEngine</span><br><span class="line">    &#125;</span><br><span class="line">    override fun onPostResume() &#123;</span><br><span class="line">        super.onPostResume()</span><br><span class="line">        flutterFragment?.onPostResume()</span><br><span class="line">    &#125;</span><br><span class="line">    override fun onNewIntent(intent: Intent) &#123;</span><br><span class="line">        super.onNewIntent(intent)</span><br><span class="line">        flutterFragment?.onNewIntent(intent)</span><br><span class="line">    &#125;</span><br><span class="line">    override fun onBackPressed() &#123;</span><br><span class="line">        super.onBackPressed()</span><br><span class="line">        flutterFragment?.onBackPressed()</span><br><span class="line">    &#125;</span><br><span class="line">    override fun onRequestPermissionsResult(</span><br><span class="line">        requestCode: Int,</span><br><span class="line">        permissions: Array&lt;out String&gt;,</span><br><span class="line">        grantResults: IntArray</span><br><span class="line">    ) &#123;</span><br><span class="line">        super.onRequestPermissionsResult(requestCode, permissions, grantResults)</span><br><span class="line">        flutterFragment?.onRequestPermissionsResult(requestCode, permissions, grantResults)</span><br><span class="line">    &#125;</span><br><span class="line">    override fun onUserLeaveHint() &#123;</span><br><span class="line">        super.onUserLeaveHint()</span><br><span class="line">        flutterFragment?.onUserLeaveHint()</span><br><span class="line">    &#125;</span><br><span class="line">    override fun onTrimMemory(level: Int) &#123;</span><br><span class="line">        super.onTrimMemory(level)</span><br><span class="line">        flutterFragment?.onTrimMemory(level)</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    override fun onDestroy() &#123;</span><br><span class="line">        super.onDestroy()</span><br><span class="line">        flutterEngine.destroy()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面代码直接是已初始化引擎的方式打开 FlutterFragmetn 的，这样的好处是加载更加块。</p>
<p>需要注意的是，如果要实现 Flutter 所有预期的行为，必须将这些信号转发到 FlutterFragment 中，这也就是上面为什么重新这么多方法的原因了。</p>
<h3 id="从指定的入口点运行-FlutterFragment"><a href="#从指定的入口点运行-FlutterFragment" class="headerlink" title="从指定的入口点运行 FlutterFragment"></a>从指定的入口点运行 FlutterFragment</h3><p>与不同的初始路由类似，不同的flutterfragment可能希望执行不同的Dart入口点。在一个典型的Flutter应用程序中，只有一个Dart入口点:main()，但你可以定义其他入口点。</p>
<p>FlutterFragment 支持为给定的Flutter体验执行所需Dart入口点的规格。要指定一个入口点，请构建FlutterFragment，如下所示:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FlutterFragment.withNewEngine()</span><br><span class="line">    .dartEntrypoint(&quot;newMain&quot;)</span><br><span class="line">    .build()</span><br></pre></td></tr></table></figure>

<p>FlutterFragment 会启动一个名字为 newMian 的入口点。</p>
<p>flutter 端的配置如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">void main() =&gt; runApp(MyApp(window.defaultRouteName));</span><br><span class="line">void newMain() =&gt; runApp(NewMainApp());</span><br></pre></td></tr></table></figure>

<p>需要注意的是，必须配置在 main.dart 文件中。</p>
<p>当 FlutterFragment 使用缓存时， Dart 入口点属性无效，所以指定入口后无法使用缓存。</p>
<h3 id="控制-FlutterFragment-的渲染模式"><a href="#控制-FlutterFragment-的渲染模式" class="headerlink" title="控制 FlutterFragment 的渲染模式"></a>控制 FlutterFragment 的渲染模式</h3><p>Flutter 可以使用 SufaceView 来渲染他的内容，也可以使用 TextureView 。</p>
<p>FlutterFragment 默认使用 SurfaceView。它的新能明显高于 TextureView，但是 SufaceView 不能再 Android View 层次结构中交叉，SurfaceView 必须是最下面的视图，或者是最上面的视图。</p>
<p>此外，在 Android N 之前的版本中，SurfaceView 不能使用动画，因为他们的布局渲染和 View 的层次结构的其他部分不同。</p>
<p>那么您需要使用 TextureView 而不是 SurfaceView。通过使用 RenderMode 构建 FlutterFragment 来选择 TextureView，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">val flutterFragment = FlutterFragment.withCachedEngine(&quot;my_engine_id&quot;)</span><br><span class="line">    .renderMode(FlutterView.RenderMode.texture)</span><br><span class="line">    .build()</span><br></pre></td></tr></table></figure>

<h3 id="具有透明度的-FlutterFragment"><a href="#具有透明度的-FlutterFragment" class="headerlink" title="具有透明度的 FlutterFragment"></a>具有透明度的 FlutterFragment</h3><p>默认情况下，FlutterFragment 使用 SurfaceView 呈现不透明背景。 对于任何不是由 Flutter 绘制的像素，该背景都是黑色的。出于性能原因，使用不透明背景渲染是首选渲染模式。在 Android 上具有透明度的 Flutter 渲染会对性能产生负面影响。但是，有许多设计需要在 Flutter 体验中显示透明像素，这些像素会显示到底层 Android UI。因此，Flutter 在 FlutterFragment 中支持半透明</p>
<p>SurfaceView 和 TextureView 都支持透明度。但是，当 SurfaceView 被指示以透明方式呈现时，它会将自己定位在比所有其他 Android 视图更高的 z-index 上，这意味着它会出现在所有其他视图之上。这是 SurfaceView 的限制。如果在所有其他内容之上渲染您的 Flutter 体验是可以接受的，那么 FlutterFragment 的表面默认 RenderMode 就是您应该使用的 RenderMode。但是，如果您需要在 Flutter 体验的上方和下方显示 Android 视图，则必须指定的 RenderMode.texture。有</p>
<p>使用方式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FlutterFragment flutterFragment = FlutterFragment.withCachedEngine(&quot;my_engine_id&quot;)</span><br><span class="line">    .transparencyMode(FlutterView.TransparencyMode.transparent)</span><br><span class="line">    .build();</span><br></pre></td></tr></table></figure>

<h3 id="FlutterFragment及其Activity之间的关系"><a href="#FlutterFragment及其Activity之间的关系" class="headerlink" title="FlutterFragment及其Activity之间的关系"></a>FlutterFragment及其Activity之间的关系</h3><p>有些应用选择使用Fragments作为整个Android屏幕。在这些应用中，用Fragment来控制系统chrome是合理的，比如Android的状态栏、导航栏和方向。</p>
<p>在其他应用程序中，片段仅用于表示 UI 的一部分。 FlutterFragment 可用于实现抽屉、视频播放器或单张卡片的内部。在这些情况下，FlutterFragment 影响 Android 的系统 chrome 是不合适的，因为在同一个 Window 中还有其他 UI 片段。</p>
<p>FlutterFragment 带有一个概念，可以帮助区分 FlutterFragment 应该能够控制其宿主 Activity 的情况，以及 FlutterFragment 应该只影响其自身行为的情况。为了防止 FlutterFragment 将其 Activity 暴露给 Flutter 插件，并防止 Flutter 控制 Activity 的系统 UI，请使用 FlutterFragment 的 Builder 中的 shouldAttachEngineToActivity() 方法，如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FlutterFragment flutterFragment = FlutterFragment.withCachedEngine(&quot;my_engine_id&quot;)</span><br><span class="line">    //此FlutterFragment是否应自动附加其Activity作为其FlutterEngine的控制面。</span><br><span class="line">    .shouldAttachEngineToActivity(false)</span><br><span class="line">    .build();</span><br></pre></td></tr></table></figure>

<h3 id="Flutter-和-Android-通信"><a href="#Flutter-和-Android-通信" class="headerlink" title="Flutter 和 Android 通信"></a>Flutter 和 Android 通信</h3><p>在进行通信之前先介绍一下 Platform Channel ，他是 Flutter 和原生通信的工具，有三种类型：</p>
<p>BaseicMessageChannel：用于传递字符串和半结构化信息，Flutter 和平台端进行消息数据交换时可以以使用。</p>
<p>MethodChannel ：用于传递方法调用(method invocation)，Flutter 和平台端进行直接方法调用时候可以使用</p>
<p>EventChannel ：用户数据流 (event stream) 的通信，Flutter 和平台端的事件监听，取消等都可以使用</p>
<p>在日常开发中最常用的也就是 MethodChannel 了，关于其他的两种可自行查阅网上的文章</p>
<h3 id="Android-调用-Flutter-方法"><a href="#Android-调用-Flutter-方法" class="headerlink" title="Android 调用 Flutter 方法"></a>Android 调用 Flutter 方法</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">val methodChannel =</span><br><span class="line">    MethodChannel(flutterEngine.dartExecutor, &quot;com.example.AndroidWithFlutter/native&quot;)</span><br></pre></td></tr></table></figure>

<p>上面代码中定义了一个 MtthodChannel ，第一个参数是一个接口，是与 Flutter 进行通信的工具，第二个参数是 name，就是 channel 的名称（这个名称需要和 Flutter 中定义的一致）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//调用 Flutter 方法</span><br><span class="line">methodChannel.invokeMethod(&quot;flutterMethod&quot;,&quot;调用 Flutter 参数&quot;,object : MethodChannel.Result &#123;</span><br><span class="line">    override fun success(result: Any?) &#123;</span><br><span class="line">  Log.e(&quot;---345---&gt;&quot;, &quot;$result&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    override fun error(errorCode: String?, errorMessage: String?, errorDetails: Any?) &#123;</span><br><span class="line">  Log.e(&quot;---345---&gt;&quot;, &quot;调用Flutter失败&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    override fun notImplemented() &#123;&#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面代码中调用了 Flutter 中名字为 flutterMethod 的方法，其中第一个参数为方法名字，第二个是参数，回调中是调用结果和是否调用成功。下面我们看一下 Flutter 中如何定义：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">final _channel = const MethodChannel(&quot;com.example.AndroidWithFlutter/native&quot;);</span><br><span class="line">@override</span><br><span class="line">void initState() &#123;</span><br><span class="line">  super.initState();</span><br><span class="line">  ///监听android端的调用</span><br><span class="line">  _channel.setMethodCallHandler((call) async &#123;</span><br><span class="line">    switch (call.method) &#123;</span><br><span class="line">      case &quot;flutterMethod&quot;:</span><br><span class="line">        print(&quot;参数：$&#123;call.arguments&#125;&quot;);</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">    return &quot;我是 Flutter 返回值&quot;;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面代码中监听 android 端的调用，接着根据方法名字判断是哪个方法即可。</p>
<p>需要注意的是，在调用 Flutter 的时候，即使没有打开页面，也能调用其方法，这是应为已经缓存过 flutterEngine 了，flutterEngine 中会直接执行 dart 代码，所以可以直接调用。但是如果在页面跳转的时候没有使用缓存。这个时候虽然显示调用成功了，但是跳转过去是拿不到对应的参数的，因为没有使用缓存，不是同一个对象，所以不行，这里需要注意一下。</p>
<h3 id="Flutter-调用-Android-方法"><a href="#Flutter-调用-Android-方法" class="headerlink" title="Flutter 调用 Android 方法"></a>Flutter 调用 Android 方法</h3><p>flutter端代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">void _incrementCounter() &#123;</span><br><span class="line">  //调用 Android 的 AndroidMethod 方法</span><br><span class="line">  var result = _channel.invokeMapMethod(&quot;AndroidMethod&quot;, &quot;调用 Android 参数&quot;);</span><br><span class="line">  result.then((value) =&gt; print(&#x27;Android 返回值 :$value&#x27;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>android 端代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">methodChannel.setMethodCallHandler &#123; call, result -&gt;</span><br><span class="line">    when (call.method) &#123;</span><br><span class="line">        &quot;AndroidMethod&quot; -&gt; &#123;</span><br><span class="line">            result.success(mapOf(&quot;Android 返回值&quot; to &quot;\&quot;我是Android\&quot;&quot;))</span><br><span class="line">        &#125;</span><br><span class="line">        else -&gt; &#123;</span><br><span class="line">            result.success(&quot;我是Android,没招到对应方法&quot;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里需要注意的就是 flutter 调用 android 的时候限制了返回值必须为 map，这点需要注意一下；</p>
<h3 id="Flutter-跳转-Android-页面"><a href="#Flutter-跳转-Android-页面" class="headerlink" title="Flutter 跳转 Android 页面"></a>Flutter 跳转 Android 页面</h3><p>flutter 跳转 android 页面实际上使用的是 MethodChannel ，需要跳转的时候，flutter 调用一下 android，在 android 端执行跳转的逻辑即可，如下所示：</p>
<p>flutter 端代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">void _incrementCounter() &#123; </span><br><span class="line">  //打开原生页面</span><br><span class="line">  _channel.invokeMapMethod(&quot;jumpToNative&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>android 端代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">//监听flutter调用 android</span><br><span class="line">methodChannel.setMethodCallHandler &#123; call, result -&gt;</span><br><span class="line">    when (call.method) &#123;</span><br><span class="line">        &quot;AndroidMethod&quot; -&gt; &#123;</span><br><span class="line">            result.success(mapOf(&quot;Android 返回值&quot; to &quot;\&quot;我是Android\&quot;&quot;))</span><br><span class="line">        &#125;</span><br><span class="line">        &quot;jumpToNative&quot; -&gt; &#123;</span><br><span class="line">            //跳转登录页面</span><br><span class="line">            startActivity(Intent(this, LoginActivity::class.java))</span><br><span class="line">        &#125;</span><br><span class="line">        else -&gt; &#123;</span><br><span class="line">            result.success(&quot;我是Android,没招到对应方法&quot;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="页面返回传参的实现"><a href="#页面返回传参的实现" class="headerlink" title="页面返回传参的实现"></a>页面返回传参的实现</h3><p>实现方式和上面的差不多，也是借助 MethodChannel ，在页面返回的时候使用 channel 调用一下传入对应的参数即可。</p>
<h2 id="内存使用情况"><a href="#内存使用情况" class="headerlink" title="内存使用情况"></a>内存使用情况</h2><p>我们对项目使用 flutter 之后和未使用的时候做了一个内存观测，具体如下：</p>
<p>未引入 flutter module：</p>
<p><img src="/../images/flutter/k22ievwfwhuoo_6b9479a83d044290ba1e73f35e0fb2f1.png"></p>
<p>引入 flutter module：</p>
<p>只启动一个缓存引擎：</p>
<p><img src="/../images/flutter/k22ievwfwhuoo_3f26e9f0979240da8b631dc246ca1fbc.png"></p>
<p>查看上面的图片，可以发现 未引入之前内存使用只有 55Mb 左右，而在初始化了 fluuter 引擎(Engine) 之后，内存瞬间到了 181Mb 。并且这还是初始化了单个的情况下。</p>
<p>下面看一下初始化多个会有什么影响：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">initFlutterEngine(&quot;init_one&quot;)</span><br><span class="line">    initFlutterEngine(&quot;init_two&quot;)</span><br><span class="line">    initFlutterEngine(&quot;init_three&quot;)</span><br><span class="line">private fun initFlutterEngine(id: String): FlutterEngine &#123;</span><br><span class="line">    //创建 Flutter 引擎</span><br><span class="line">    val flutterEngine = FlutterEngine(this)</span><br><span class="line">    //指定要跳转的flutter页面</span><br><span class="line">    flutterEngine.navigationChannel.setInitialRoute(&quot;main&quot;)</span><br><span class="line">    flutterEngine.dartExecutor.executeDartEntrypoint(DartExecutor.DartEntrypoint.createDefault())</span><br><span class="line">    //这里做一个缓存，可以在适当的时候执行它，例如app里，在跳转前执行预加载</span><br><span class="line">    val flutterEngineCache = FlutterEngineCache.getInstance();</span><br><span class="line">    flutterEngineCache.put(id, flutterEngine)</span><br><span class="line">    //上面代码一般在跳转之前调用，这样可以使得跳转树的加快</span><br><span class="line">    return flutterEngine</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码如上所示，下面看一下结果：</p>
<p><img src="/../images/flutter/k22ievwfwhuoo_06145391f5dc4d6abc4a47c316e134f2.png"></p>
<p>可以看到，一共初始化了四个缓存，共使用了 355Mb。比之前使用一个多了 174Mb,平均每增加一个缓存就会增加 60Mb 。</p>
<p>通过上面的验证，可以得出，使用了 Flutter 之后，内存确实会增加很多，但是并不会造成内存压力。</p>
<p>通增加缓存引擎的对比，发现每次增加一个缓存引擎，就会增加 60Mb 左右。</p>
<h2 id="总结一下："><a href="#总结一下：" class="headerlink" title="总结一下："></a>总结一下：</h2><p>一般情况下使用时没有问题的，但是需要注意的是初始化引擎的时候初始化一个即可。不能每次打开页面都重新进行初始化引擎。</p>
</div>
        </div>
        
            <div class="kratos-copyright text-center clearfix">
                <h5 itemprop="copyrightNotice">本作品采用 <a rel="license nofollow" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">知识共享署名-相同方式共享 4.0 国际许可协议</a> 进行许可</h5>
            </div>
        
        <footer class="kratos-entry-footer clearfix">
            
                <div class="post-like-donate text-center clearfix" id="post-like-donate">
                
                
                    <a class="share" href="javascript:;"><i class="fa fa-share-alt"></i> 分享</a>
                    <div class="share-wrap" style="display: none;">
    <div class="share-group">
        <a href="javascript:;" class="share-plain qq" onclick="share('qq');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-qq"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain qzone" onclick="share('qzone');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-star"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain weixin pop style-plain" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-weixin"></i>
            </div>
            <div class="share-int">
                <div class="qrcode" id="wechat-qr"></div>
                <p>打开微信“扫一扫”，打开网页后点击屏幕右上角分享按钮</p>
            </div>
        </a>
        <a href="javascript:;" class="share-plain weibo" onclick="share('weibo');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-weibo"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain facebook style-plain" onclick="share('facebook');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-facebook"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain twitter style-plain" onclick="share('twitter');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-twitter"></i>
            </div>
        </a>
    </div>
    <script type="text/javascript">
        $(()=>{
            new QRCode("wechat-qr", {
                text: "http://example.com/09/Flutter-%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%97%8514-%E5%9C%A8Android%E9%A1%B9%E7%9B%AE%E4%B8%AD%E9%9B%86%E6%88%90Flutter%E9%A1%B9%E7%9B%AE/",
                width: 150,
                height: 150,
                correctLevel : QRCode.CorrectLevel.H
            });
        });
        function share(dest) {
            const qqBase        = "https://connect.qq.com/widget/shareqq/index.html?";
            const weiboBase     = "https://service.weibo.com/share/share.php?";
            const qzoneBase     = "https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?";
            const facebookBase  = "https://www.facebook.com/sharer/sharer.php?";
            const twitterBase   = "https://twitter.com/intent/tweet?";
            const hostUrl       = "http://example.com/09/Flutter-%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%97%8514-%E5%9C%A8Android%E9%A1%B9%E7%9B%AE%E4%B8%AD%E9%9B%86%E6%88%90Flutter%E9%A1%B9%E7%9B%AE/";
            const title         = "「Flutter 学习之旅14 在Android项目中集成Flutter项目」";
            const excerpt       = `在 Android 项目中集成 Flutter 项目首先我们需要找一个 android 项目，以这个为基础来集成 Fluuter。下面来看一下具体的步骤
创建 flutter 模块
在 AndroidStudio 的 Terminal...`;
            let _URL;
            switch (dest) {
                case "qq"       : _URL = qqBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";     break;
                case "weibo"    : _URL = weiboBase+"url="+hostUrl+"&title="+title+excerpt;                                 break;
                case "qzone"    : _URL = qzoneBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";  break;
                case "facebook" : _URL = facebookBase+"u="+hostUrl;                                                        break;
                case "twitter"  : _URL = twitterBase+"text="+title+excerpt+"&url="+hostUrl;                                break;
            }
            window.open(_URL);
        };
    </script>
</div>
                
                </div>
            
            <div class="footer-tag clearfix">
                <div class="pull-left">
                <i class="fa fa-tags"></i>
                    
                </div>
				
            </div>
        </footer>
    </div>
    
        <nav class="navigation post-navigation clearfix" role="navigation">
            
            <div class="nav-previous clearfix">
                <a title=" iOS15适配" href="/26/iOS15适配/">&lt; 上一篇</a>
            </div>
            
            
            <div class="nav-next clearfix">
                <a title=" iOS-离屏渲染" href="/26/ios-离屏渲染/">下一篇 &gt;</a>
            </div>
            
        </nav>
    
    
</article>

        

            </section>

        

                
            

<section id="kratos-widget-area" class="col-md-4 hidden-xs hidden-sm">
    <!-- 文章和页面根据splitter来分割，没有的话就从头开始设置为sticky -->
    
    
                <aside id="krw-about" class="widget widget-kratos-about clearfix">
    <div class="photo-background"></div>
    <div class="photo-wrapper clearfix">
        <div class="photo-wrapper-tip text-center">
            <img class="about-photo" src="/images/avatar.webp" loading="lazy" decoding="auto" />
        </div>
    </div>
    <div class="textwidget">
        <p class="text-center"></p>
    </div>
    <div class="site-meta">
        <a class="meta-item" href="/archives/">
            <span class="title">
                文章
            </span>
            <span class="count">
                104
            </span>
        </a>
        <a class="meta-item" href="/categories/">
            <span class="title">
                分类
            </span>
            <span class="count">
                8
            </span>
        </a>
        <a class="meta-item" href="/tags/">
            <span class="title">
                标签
            </span>
            <span class="count">
                13
            </span>
        </a>
    </div>
</aside>
            
                    <div class="sticky-area">
                
                
  <aside id="krw-categories" class="widget widget-kratos-categories clearfix">
    <h4 class="widget-title"><i class="fa fa-folder"></i>分类目录</h4>
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Flutter/">Flutter</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS%E7%9F%A5%E8%AF%86%E7%82%B9/">iOS知识点</a><span class="category-list-count">61</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%8A%A0%E5%AF%86%E6%8A%80%E6%9C%AF/">加密技术</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/">开发工具</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9F%B3%E8%A7%86%E9%A2%91%E7%9B%B8%E5%85%B3/">音视频相关</a><span class="category-list-count">10</span></li></ul>
  </aside>


            
                
  <aside id="krw-tags" class="widget widget-kratos-tags clearfix">
    <h4 class="widget-title"><i class="fa fa-tags"></i>标签聚合</h4>
      <div class="tag-clouds">
        <a href="/tags/Cocoapods/" style="font-size: 0.6em;">Cocoapods</a> <a href="/tags/Runloop/" style="font-size: 0.6em;">Runloop</a> <a href="/tags/Swift/" style="font-size: 0.71em;">Swift</a> <a href="/tags/UI%E6%8E%A7%E4%BB%B6/" style="font-size: 0.8em;">UI控件</a> <a href="/tags/ffmpeg/" style="font-size: 0.77em;">ffmpeg</a> <a href="/tags/git/" style="font-size: 0.63em;">git</a> <a href="/tags/runtime/" style="font-size: 0.66em;">runtime</a> <a href="/tags/%E5%8A%A0%E5%AF%86/" style="font-size: 0.6em;">加密</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 0.66em;">多线程</a> <a href="/tags/%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/" style="font-size: 0.74em;">底层原理</a> <a href="/tags/%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/" style="font-size: 0.69em;">开源框架</a> <a href="/tags/%E6%99%BA%E8%83%BD%E8%AE%BE%E5%A4%87/" style="font-size: 0.63em;">智能设备</a> <a href="/tags/%E7%BB%84%E4%BB%B6%E5%8C%96/" style="font-size: 0.66em;">组件化</a>
      </div>
  </aside>

            
                
  <aside id="krw-posts" class="widget widget-kratos-posts">
  <h4 class="widget-title"><i class="fa fa-file"></i>最新文章</h4>
  <div class="tab-content">
      <ul class="list-group">
        
        
          
          
            <a class="list-group-item" href="/11/%E8%87%AA%E5%90%AF%E5%8A%A8%E5%AF%BC%E8%87%B4%E4%B8%8A%E6%9E%B6%E8%A2%AB%E6%89%93%E5%9B%9E%E7%9A%84%E5%A4%84%E7%90%86/"><i class="fa  fa-book"></i> 自启动导致上架被打回的处理</a>
            
          
        
          
          
            <a class="list-group-item" href="/20/%E4%BD%BF%E7%94%A8FFmpeg%E5%BA%93%E5%AF%B9%E9%9F%B3%E9%A2%91%E8%BF%9B%E8%A1%8C%E7%BC%96%E7%A0%81/"><i class="fa  fa-book"></i> 使用FFmpeg库对音频进行编码</a>
            
          
        
          
          
            <a class="list-group-item" href="/09/%E4%BD%BF%E7%94%A8FFmpeg%E5%BA%93%E5%AF%B9%E8%A7%86%E9%A2%91%E8%BF%9B%E8%A1%8C%E7%BC%96%E7%A0%81/"><i class="fa  fa-book"></i> 使用FFmpeg库对视频进行编码</a>
            
          
        
          
          
            <a class="list-group-item" href="/10/%E4%BD%BF%E7%94%A8FFmpeg%E5%BA%93%E5%AF%B9%E8%A7%86%E9%A2%91%E8%B5%84%E6%BA%90%E8%BF%9B%E8%A1%8C%E6%A0%BC%E5%BC%8F%E8%BD%AC%E6%8D%A2/"><i class="fa  fa-book"></i> 使用FFmpeg库对视频资源进行格式转换</a>
            
          
        
          
          
            <a class="list-group-item" href="/17/XCode14-iOS16-%E9%80%82%E9%85%8D%E9%97%AE%E9%A2%98/"><i class="fa  fa-book"></i> XCode14 & iOS16 适配问题</a>
            
          
        
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
      </ul>
  </div>
  </aside>

            
    </div>
</section>
        
        </div>
    </div>
</div>
<footer>
    <div id="footer"  class="ap-lrc"  >
        <div class="container">
            <div class="row">
                <div class="col-md-6 col-md-offset-3 footer-list text-center">
                    <ul class="kratos-social-icons">
                        
                        
                        <li><a target="_blank" rel="nofollow" href="https://t.me/CandyUnion"><i class="fa fa-telegram"></i></a></li>
                        
                        
                        
                        <li><a target="_blank" rel="me" href="https://nya.one/@Candinya"><i class="fa fa fa-share-alt-square"></i></a></li>
                        <li><a target="_blank" rel="nofollow" href="https://github.com/Candinya"><i class="fa fa-github"></i></a></li>
                        
                    </ul>
                    <ul class="kratos-copyright">
                        <div>
                            <li>&copy; 2023 欢迎来到我的个人博客 版权所有.</li>
                            
                        </div>
                    </ul>
                </div>
            </div>
        </div>
        <div class="kr-tool text-center">
            <div class="tool">
                
                    <div class="box search-box">
                        <a href="/search/">
                            <span class="fa fa-search"></span>
                        </a>
                    </div>
                
                
                    <div class="box theme-box" id="darkmode-switch">
                        <span class="fa fa-adjust"></span>
                    </div>
                
                
            </div>
            <div class="box gotop-box">
                <span class="fa fa-chevron-up"></span>
            </div>
        </div>
    </div>
</footer>
</div>
</div>

        <script defer src="/vendors/bootstrap@3.3.4/dist/js/bootstrap.min.js"></script>
<script defer src="/vendors/nprogress@0.2.0/nprogress.js"></script>
<script>
    if (!window.kr) {
        window.kr = {};
    }
    window.kr.notMobile = (!(navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)));
    window.kr.siteRoot = "/";
</script>


    <script async src="/js/candy.min.js"></script>



    <script defer src="/vendors/aplayer@1.10.1/dist/APlayer.min.js"></script>
    
    <script defer src="/vendors/meting@2.0.1/dist/Meting.min.js"></script>
    <meting-js
        server="netease"
        type="playlist"
        id="3204190542"
        order="random"
        fixed="true"
    >
    </meting-js>



    <script defer src="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

<script defer src="/vendors/clipboard@2.0.6/dist/clipboard.min.js"></script>
<script defer src="/js/kratosr.min.js"></script>
<script defer src="/js/pjax.min.js"></script>



<!-- Extra support for third-party plguins  -->


    </body>
</html>