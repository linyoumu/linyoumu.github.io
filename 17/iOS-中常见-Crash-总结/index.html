<!DOCTYPE html>
<html lang="en">
    <head>
  <!-- 元数据 -->
  <meta charset="utf-8">
  
  
  <title>iOS 中常见 Crash 总结 | 欢迎来到我的个人博客</title>
  <meta name="author" content="勿忘初心" />
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="robots" content="index,follow" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="format-detection" content="telphone=no, email=no" />
  
    <meta name="keywords" content="" />
  
  <meta name="description" content="1、找不到方法的实现unrecognized selector sent to instance 2、KVC造成的crash 3、EXC_BAD_ACCESS 4、KVO引起的崩溃 5、集合类相关崩溃 6、多线程中的崩溃 7、Socket长连接，进入后台没有关闭 8、Watch Dog超时造成的crash 9、后台返回NSNull导致的崩溃，多见于Java做后台服务器开发语言  1、找不到方法的">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS 中常见 Crash 总结">
<meta property="og:url" content="http://example.com/17/iOS-%E4%B8%AD%E5%B8%B8%E8%A7%81-Crash-%E6%80%BB%E7%BB%93/index.html">
<meta property="og:site_name" content="欢迎来到我的个人博客">
<meta property="og:description" content="1、找不到方法的实现unrecognized selector sent to instance 2、KVC造成的crash 3、EXC_BAD_ACCESS 4、KVO引起的崩溃 5、集合类相关崩溃 6、多线程中的崩溃 7、Socket长连接，进入后台没有关闭 8、Watch Dog超时造成的crash 9、后台返回NSNull导致的崩溃，多见于Java做后台服务器开发语言  1、找不到方法的">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2019-05-17T13:14:38.000Z">
<meta property="article:modified_time" content="2022-09-21T09:31:19.000Z">
<meta property="article:author" content="勿忘初心">
<meta name="twitter:card" content="summary">
  
  <!-- 站点验证相关 -->
  
    
    
    
  
  <!-- 样式表文件 -->
  <link rel="stylesheet" id="kratos-css" href="/css/kratosr.min.css" media="all"></script>
  
    <link rel="stylesheet" id="darkmode-css" href="/css/kr-color-dark.min.css" media="(prefers-color-scheme: dark)"></script>
    <script src="/js/kr-dark.min.js"></script>
  
  
    <link rel="stylesheet" id="highlight-css" href="/css/highlight/night-eighties.min.css" media="all"></script>
  
  
  <link rel="stylesheet" id="fontawe-css" href="/vendors/font-awesome@4.7.0/css/font-awesome.min.css" media="all"></script>
  <link rel="stylesheet" id="nprogress-css" href="/vendors/nprogress@0.2.0/nprogress.css" media="all"></script>
  
  
    <link rel="stylesheet" href="/vendors/aplayer@1.10.1/dist/APlayer.min.css"></script>
  
  
    <link rel="stylesheet" href="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"></script>
  
  <!-- 不得不预先加载的一些JS文件 -->
  <script src="/vendors/jquery@3.6.0/dist/jquery.min.js"></script>
  
    <script src="/vendors/qrcode_js@1.0.0/qrcode.min.js"></script>
  
  
  <style>
    
      .kratos-cover.kratos-cover-2 {
        background-image: url('/images/banner.webp');
      }
    
    
      @media(min-width:768px) {
        body.custom-background {
          background-image: url('/images/bg.webp');
        }
      }
    
  </style>
  
<meta name="generator" content="Hexo 6.3.0"></head>


    <body class="custom-background">
        <div id="kratos-wrapper">
    <div id="kratos-page">
        <div id="kratos-header">
            <header id="kratos-desktop-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="nav-header">
                        <nav id="kratos-menu-wrap">
                            <ul id="kratos-primary-menu" class="sf-menu">
                                
                                    
                                    
                                
                            </ul>
                        </nav>
                    </div>
                </div>
            </header>
            <header id="kratos-mobile-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="color-logo"><a href="/">欢迎来到我的个人博客</a></div>
                    <div class="nav-toggle">
                        <a class="kratos-nav-toggle js-kratos-nav-toggle">
                            <i></i>
                        </a>
                    </div>
                </div>
            </header>
        </div>
        <div class="kratos-start kratos-hero-2">
            <!-- <div class="kratos-overlay"></div> -->
            <div class="kratos-cover kratos-cover-2 text-center">
                <div class="desc desc2 animate-box">
                    <a href="/">
                        <h2>欢迎来到我的个人博客</h2> <br />
                        <span></span>
                    </a>
                </div>
            </div>
        </div>

        <div id="kratos-blog-post">
            <div class="container">
                <div id="main" class="row">
                    

        

            <section class="col-md-8">

        

            <article itemscope itemtype="https://schema.org/Article">
    
    <link itemprop="mainEntityOfPage" href="http://example.com/17/iOS-%E4%B8%AD%E5%B8%B8%E8%A7%81-Crash-%E6%80%BB%E7%BB%93/">
    <div class="kratos-hentry kratos-post-inner clearfix">
        <header class="kratos-entry-header">
            
                <h1 class="kratos-entry-title text-center" itemprop="name headline">iOS 中常见 Crash 总结</h1>
            
            
            <ul class="kratos-post-meta text-center">
                <li><time datetime="2019-05-17T13:14:38.000Z" itemprop="datePublished"><i class="fa fa-calendar"></i> 2019-05-17</time></li>
                <li itemprop="author" itemscope itemtype="https://schema.org/Person">
                    <i class="fa fa-user"></i> 作者 <span itemprop="name">勿忘初心</span>
                </li>
                <li>
                    <i class="fa fa-edit"></i> 
                    
                    
                        ~23.51K
                    
                    字
                </li>
                
            </ul>
        </header>
        <div class="kratos-post-content">
            
            <div id="expire-alert" class="alert alert-warning hidden" role="alert">
                <div class="icon"><i class="fa fa-warning"></i></div>
                <div class="text"><p>本文最后编辑于 <time datetime="1663752679000"></time> 前，其中的内容可能需要更新。</p></div>
            </div>
            
            
            
            <hr />
            <div itemprop="articleBody"><blockquote>
<p>1、找不到方法的实现unrecognized selector sent to instance</p>
<p>2、KVC造成的crash</p>
<p>3、EXC_BAD_ACCESS</p>
<p>4、KVO引起的崩溃</p>
<p>5、集合类相关崩溃</p>
<p>6、多线程中的崩溃</p>
<p>7、Socket长连接，进入后台没有关闭</p>
<p>8、Watch Dog超时造成的crash</p>
<p>9、后台返回NSNull导致的崩溃，多见于Java做后台服务器开发语言</p>
</blockquote>
<h3 id="1、找不到方法的实现unrecognized-selector-sent-to-instance"><a href="#1、找不到方法的实现unrecognized-selector-sent-to-instance" class="headerlink" title="1、找不到方法的实现unrecognized selector sent to instance"></a><strong>1、找不到方法的实现</strong>unrecognized selector sent to instance</h3><h4 id="1-1、场景对应的Code"><a href="#1-1、场景对应的Code" class="headerlink" title="1.1、场景对应的Code"></a><strong>1.1、场景对应的Code</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;UnrecognizedSelectorVC.h&quot;</span><br><span class="line">/**</span><br><span class="line"> 代理协议</span><br><span class="line"> */</span><br><span class="line">@protocol UnrecognizedSelectorVCDelegate &lt;NSObject&gt;</span><br><span class="line">@optional</span><br><span class="line">- (void)notImplementionFunc;</span><br><span class="line">@end</span><br><span class="line">/**</span><br><span class="line"> 测试控制器的代理对象</span><br><span class="line"> */</span><br><span class="line">@interface UnrecognizedSelectorVCObj : NSObject&lt;UnrecognizedSelectorVCDelegate&gt;</span><br><span class="line">@property (nonatomic, strong) NSString *name;</span><br><span class="line">@end</span><br><span class="line">@implementation UnrecognizedSelectorVCObj</span><br><span class="line">@end</span><br><span class="line">  </span><br><span class="line">/**</span><br><span class="line"> 测试控制器</span><br><span class="line"> */</span><br><span class="line">@interface UnrecognizedSelectorVC ()</span><br><span class="line">@property(nonatomic, weak) id&lt;UnrecognizedSelectorVCDelegate&gt; delegate;</span><br><span class="line">@property(nonatomic, copy) NSMutableArray *mutableArray;</span><br><span class="line">@end</span><br><span class="line">  </span><br><span class="line">@implementation UnrecognizedSelectorVC</span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    [self case1];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> 场景一：没有实现代理</span><br><span class="line"> */</span><br><span class="line">- (void)case1 &#123;</span><br><span class="line">    UnrecognizedSelectorVCObj* obj = [[UnrecognizedSelectorVCObj alloc] init];</span><br><span class="line">    self.delegate = obj;</span><br><span class="line">    // 崩溃：reason: &#x27;-[UnrecognizedSelectorVCObj notImplementionFunc]: unrecognized selector sent to instance 0x2808047f0&#x27;</span><br><span class="line">    [self.delegate notImplementionFunc];</span><br><span class="line">    // 解决办法：应该使用下面的代码</span><br><span class="line">    if ( [self.delegate respondsToSelector:@selector(notImplementionFunc)] ) &#123;</span><br><span class="line">        [self.delegate notImplementionFunc];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> 场景二：可变属性使用copy修饰</span><br><span class="line"> */</span><br><span class="line">- (void)case2 &#123;</span><br><span class="line">    NSMutableArray* array = [NSMutableArray arrayWithObjects:@1, @2, @3, nil];</span><br><span class="line">    self.mutableArray = array;</span><br><span class="line">    // 崩溃：reason: &#x27;-[__NSArrayI addObject:]: unrecognized selector sent to instance 0x281198a50&#x27;</span><br><span class="line">    [self.mutableArray addObject:@4];</span><br><span class="line">    // 原因：NSMutableArray经过copy之后变成NSArray</span><br><span class="line">    // @property (nonatomic, copy) NSMutableArray *mArray;</span><br><span class="line">    // 等同于</span><br><span class="line">    // - (void)setMArray:(NSMutableArray *)mArray &#123;</span><br><span class="line">    //    _mArray = mArray.copy;</span><br><span class="line">    //&#125;</span><br><span class="line">    // 解决办法：使用strong修饰或者重写set方法</span><br><span class="line"></span><br><span class="line">    // 知识点：集合类对象和非集合类对象的copy与mutableCopy</span><br><span class="line">    // [NSArray copy]                  // 浅复制(新的和原来的是一个array)</span><br><span class="line">    // [NSArray mutableCopy]           // 深复制(array是新的，但是内容还是原来的，内容的指针没有变化)</span><br><span class="line">    // [NSMutableArray copy]           // 深复制(array是新的，但是内容还是原来的，内容的指针没有变化)</span><br><span class="line">    // [NSMutableArray mutableCopy]    // 深复制(array是新的，但是内容还是原来的，内容的指针没有变化)</span><br><span class="line">&#125;</span><br><span class="line">/**</span><br><span class="line"> 场景三：低版本系统使用高版本API</span><br><span class="line"> */</span><br><span class="line">- (void)case3 &#123;</span><br><span class="line">    if (@available(iOS 10.0, *)) &#123;</span><br><span class="line">        [NSTimer scheduledTimerWithTimeInterval:1 repeats:YES block:^(NSTimer * _Nonnull timer) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // Fallback on earlier versions</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>

<h4 id="1-2、原因"><a href="#1-2、原因" class="headerlink" title="1.2、原因"></a><strong>1.2、原因</strong></h4><blockquote>
<p>找不到方法iOS系统抛出异常崩溃</p>
</blockquote>
<h4 id="1-3、解决方案"><a href="#1-3、解决方案" class="headerlink" title="1.3、解决方案"></a>1.3、解决方案</h4><p>1、给NSObject添加一个分类，实现<code>消息转发</code>的几个方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;NSObject+SelectorCrash.h&quot;</span><br><span class="line">@implementation NSObject (SelectorCrash)</span><br><span class="line">- (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector &#123;</span><br><span class="line">    if ([self respondsToSelector:aSelector]) &#123;</span><br><span class="line">        // 已实现不做处理</span><br><span class="line">        return [self methodSignatureForSelector:aSelector];</span><br><span class="line">    &#125;</span><br><span class="line">    return [NSMethodSignature signatureWithObjCTypes:&quot;v@:&quot;];</span><br><span class="line">&#125;</span><br><span class="line">- (void)forwardInvocation:(NSInvocation *)anInvocation &#123;</span><br><span class="line">    NSLog(@&quot;在 %@ 类中, 调用了没有实现的实例方法: %@ &quot;,NSStringFromClass([self class]),NSStringFromSelector(anInvocation.selector));</span><br><span class="line">&#125;</span><br><span class="line">+ (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector &#123;</span><br><span class="line">    if ([self respondsToSelector:aSelector]) &#123;</span><br><span class="line">        // 已实现不做处理</span><br><span class="line">        return [self methodSignatureForSelector:aSelector];</span><br><span class="line">    &#125;</span><br><span class="line">    return [NSMethodSignature signatureWithObjCTypes:&quot;v@:&quot;];</span><br><span class="line">&#125;</span><br><span class="line">+ (void)forwardInvocation:(NSInvocation *)anInvocation &#123;</span><br><span class="line">    NSLog(@&quot;在 %@ 类中, 调用了没有实现的类方法: %@ &quot;,NSStringFromClass([self class]),NSStringFromSelector(anInvocation.selector));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>2、尽量避免使用<code>performSelector</code>一系列方法</p>
<p>3、<code>delegate</code> 方法调用前进行 <code>respondsToSelector</code> 判断，或者Release模式下使用<a href="https://link.juejin.im/?target=https://github.com/forkingdog/ProtocolKit">ProtocolKit</a>给协议添加默认实现防止崩溃，Debug模式下关闭默认实现</p>
<p>4、<code>属性</code>和<code>成员变量</code>不要重名定义，合理使用 <code>synthesize</code> 生成属性的 <code>setter</code> 和 <code>getter</code> 方法</p>
<p>5、在<code>MRC</code>模式下，变量的 <code>retain</code> 和 <code>release</code> 要谨慎，建议采用安全 release方法，即 <code>release</code> 的对象置为 nil</p>
<p>6、在.h中声明的方法如果用不到就去掉，用得到就同时在.m文件中实现</p>
<p>7、可变属性（如<code>NSMutableArray</code>），不要使用<code>copy</code>修饰，或者重写<code>set</code>方法</p>
<p>8、使用<code>高版本的系统方法</code>的时候做判断</p>
<h4 id="1-4、知识归纳：参考runtime-消息转发"><a href="#1-4、知识归纳：参考runtime-消息转发" class="headerlink" title="1.4、知识归纳：参考runtime 消息转发"></a><strong>1.4、知识归纳：参考runtime 消息转发</strong></h4><blockquote>
<p><strong>消息转发机制</strong>主要包含<strong>三个步骤</strong>：</p>
<p><strong>1、动态方法解析阶段</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+(BOOL)resolveClassMethod:(SEL)sel`**或者**`+(BOOL)resolveInstanceMethod:(SEL)sel</span><br></pre></td></tr></table></figure>

<p><strong>2、备用接收者阶段</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (id)forwardingTargetForSelector:(SEL)aSelector</span><br></pre></td></tr></table></figure>

<p><strong>3、完整消息转发阶段</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector</span><br></pre></td></tr></table></figure>

<p><strong>和</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (void)forwardInvocation:(NSInvocation *)anInvocation</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="2、KVC造成的crash"><a href="#2、KVC造成的crash" class="headerlink" title="2、KVC造成的crash"></a><strong>2、KVC造成的crash</strong></h3><h4 id="2-1、场景对应的Code"><a href="#2-1、场景对应的Code" class="headerlink" title="2.1、场景对应的Code"></a><strong>2.1、场景对应的Code</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;KvcCrashVC.h&quot;</span><br><span class="line"></span><br><span class="line">@interface KvcCrashVCObj : NSObject</span><br><span class="line">@property (nonatomic, strong) NSString *name;</span><br><span class="line">@end</span><br><span class="line">@implementation KvcCrashVCObj</span><br><span class="line">- (void)setValue:(id)value forUndefinedKey:(NSString *)key &#123;   </span><br><span class="line">&#125;</span><br><span class="line">- (id)valueForUndefinedKey:(NSString *)key &#123;</span><br><span class="line">    return nil;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@interface KvcCrashVC ()</span><br><span class="line">@end</span><br><span class="line">@implementation KvcCrashVC</span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    [self case1];</span><br><span class="line">&#125;</span><br><span class="line">/**</span><br><span class="line"> 场景一：对象不支持KVC</span><br><span class="line"> */</span><br><span class="line">- (void)case1 &#123;</span><br><span class="line">    // reason: &#x27;[&lt;NSObject 0x282fe7f90&gt; setValue:forUndefinedKey:]: this class is not key value coding-compliant for the key key.&#x27;</span><br><span class="line">    NSObject* obj = [[NSObject alloc]init];</span><br><span class="line">    [obj setValue:@&quot;value&quot; forKey:@&quot;key&quot;];</span><br><span class="line">&#125;</span><br><span class="line">/**</span><br><span class="line"> 场景二：key为nil</span><br><span class="line"> */</span><br><span class="line">- (void)case2 &#123;</span><br><span class="line">    // reason: &#x27;*** -[KvcCrashVCObj setValue:forKey:]: attempt to set a value for a nil key&#x27;</span><br><span class="line">    KvcCrashVCObj* obj = [[KvcCrashVCObj alloc]init];</span><br><span class="line">    // value 为nil不会崩溃</span><br><span class="line">    [obj setValue:nil forKey:@&quot;name&quot;];</span><br><span class="line">    // key为nil会崩溃（直接写nil编译器会提示警告，更多时候我们传的是变量）</span><br><span class="line">    [obj setValue:@&quot;value&quot; forKey:nil];</span><br><span class="line">&#125;</span><br><span class="line">/**</span><br><span class="line"> 场景三：key不是object的属性产生的crash</span><br><span class="line"> */</span><br><span class="line">- (void)case3 &#123;</span><br><span class="line">    // reason: &#x27;[&lt;KvcCrashVCObj 0x2810bfa80&gt; setValue:forUndefinedKey:]: this class is not key value coding-compliant for the key falseKey.&#x27;</span><br><span class="line">    KvcCrashVCObj* obj = [[KvcCrashVCObj alloc]init];</span><br><span class="line">    [obj setValue:nil forKey:@&quot;falseKey&quot;];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="2-2、原因"><a href="#2-2、原因" class="headerlink" title="2.2、原因"></a><strong>2.2、原因</strong></h4><blockquote>
<p>给不存在的key（包括key为nil）设置value</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[obj setValue:@&quot;value&quot; forKey:@&quot;UndefinedKey&quot;]</span><br><span class="line">[obj valueForKey:@&quot;UndefinedKey&quot;]</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="2-3、解决方案："><a href="#2-3、解决方案：" class="headerlink" title="2.3、解决方案："></a><strong>2.3、解决方案：</strong></h4><p>1、如果属性存在，利用iOS的反射机制来规避，<code>NSStringFromSelector(@selector())</code>将<code>SEL</code>反射为字符串作为key。这样在<code>@selector()</code>中传入方法名的过程中，编译器会有合法性检查，如果方法不存在或未实现会报黄色警告。</p>
<p>2、重写类的<code>setValue:forUndefinedKey:</code>和<code>valueForUndefinedKey:</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-(void)setValue:(id)value forUndefinedKey:(NSString *)key&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">-(id)valueForUndefinedKey:(NSString *)key&#123;</span><br><span class="line">    return nil;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3、EXC-BAD-ACCESS"><a href="#3、EXC-BAD-ACCESS" class="headerlink" title="3、EXC_BAD_ACCESS"></a><strong>3、EXC_BAD_ACCESS</strong></h3><blockquote>
<p>经过<code>ARC</code>的洗礼之后，普通的访问释放对象产生的<code>EXC_BAD_ACCESS</code>已经大量减少了，现在出现的<code>EXC_BAD_ACCESS</code>有很大一部分来自malloc的对象或者越界访问。</p>
</blockquote>
<h4 id="3-1、场景对应的Code"><a href="#3-1、场景对应的Code" class="headerlink" title="3.1、场景对应的Code"></a><strong>3.1、场景对应的Code</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;BadAccessCrashVC.h&quot;</span><br><span class="line">#import &lt;objc/runtime.h&gt;</span><br><span class="line">@interface BadAccessCrashVC (AssociatedObject)</span><br><span class="line">@property (nonatomic, strong) UIView *associateView;</span><br><span class="line">@end</span><br><span class="line">@implementation BadAccessCrashVC (AssociatedObject)</span><br><span class="line">- (void)setAssociateView:(UIView *)associateView &#123;</span><br><span class="line">    objc_setAssociatedObject(self, @selector(associateView), associateView, OBJC_ASSOCIATION_ASSIGN);</span><br><span class="line">    //objc_setAssociatedObject(self, @selector(associateView), associateView, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">&#125;</span><br><span class="line">- (UIView *)associateView &#123;</span><br><span class="line">    return objc_getAssociatedObject(self, _cmd);;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@interface BadAccessCrashVC ()</span><br><span class="line">@property (nonatomic, copy)                         void(^blcok)(void);</span><br><span class="line">@property (nonatomic, weak) UIView*                 weakView;</span><br><span class="line">@property (nonatomic, unsafe_unretained) UIView*    unSafeView;</span><br><span class="line">@property (nonatomic, assign) UIView*               assignView;</span><br><span class="line">@end</span><br><span class="line">@implementation BadAccessCrashVC</span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    [self case1];</span><br><span class="line">&#125;</span><br><span class="line">/**</span><br><span class="line"> 悬挂指针：访问没有实现的blcok</span><br><span class="line"> */</span><br><span class="line">- (void)case1 &#123;</span><br><span class="line">    self.blcok();</span><br><span class="line">&#125;</span><br><span class="line">/**</span><br><span class="line"> 悬挂指针：对象没有被初始化</span><br><span class="line"> */</span><br><span class="line">- (void)case2 &#123;</span><br><span class="line">    UIView* view = [UIView alloc];</span><br><span class="line">    view.backgroundColor = [UIColor blackColor];</span><br><span class="line">    [self.view addSubview:view];</span><br><span class="line">&#125;</span><br><span class="line">/**</span><br><span class="line"> 悬挂指针：访问的对象已经被释放掉</span><br><span class="line"> */</span><br><span class="line">- (void)case3 &#123;</span><br><span class="line">    &#123;</span><br><span class="line">        UIView* view = [[UIView alloc]init];</span><br><span class="line">        view.backgroundColor = [UIColor blackColor];</span><br><span class="line">        self.weakView = view;</span><br><span class="line">        self.unSafeView = view;</span><br><span class="line">        self.assignView = view;</span><br><span class="line">        self.associateView = view;</span><br><span class="line">    &#125;</span><br><span class="line">    // ARC下weak对象释放后会自动置nil，因此下面的代码不会崩溃</span><br><span class="line">    [self.view addSubview:self.weakView];</span><br><span class="line">    // 野指针场景一：unsafe_unretained修饰的对象释放后，不会自动置nil，变成野指针，因此下面的代码会崩溃</span><br><span class="line">    [self.view addSubview:self.unSafeView];</span><br><span class="line">    // 野指针场景二：应该使用strong/weak修饰的对象，却错误的使用assign修饰，释放后不会自动置nil</span><br><span class="line">    [self.view addSubview:self.assignView];</span><br><span class="line">    // 野指针场景三：给类添加添加关联变量的时候，类似场景二，应该使用OBJC_ASSOCIATION_RETAIN_NONATOMIC修饰，却错误使用OBJC_ASSOCIATION_ASSIGN</span><br><span class="line">    [self.view addSubview:self.associateView];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>



<h4 id="3-2、原因"><a href="#3-2、原因" class="headerlink" title="3.2、原因"></a><strong>3.2、原因</strong></h4><blockquote>
<p>出现悬挂指针，对象没有被初始化，或者访问的对象被释放</p>
</blockquote>
<h4 id="3-3、解决方案："><a href="#3-3、解决方案：" class="headerlink" title="3.3、解决方案："></a><strong>3.3、解决方案：</strong></h4><p>1、<code>Debug</code>阶段开启僵尸模式，<code>Release</code>时关闭僵尸模式</p>
<p>2、使用Xcode的<code>Address Sanitizer</code>检查地址访问越界</p>
<p>3、创建对象的时候记得初始化</p>
<p>4、对象的属性使用正确的修饰方式（<code>strong/weak</code>）</p>
<p>5、调用<code>block</code>的时候，做判断</p>
<h3 id="4、KVO引起的崩溃"><a href="#4、KVO引起的崩溃" class="headerlink" title="4、KVO引起的崩溃"></a><strong>4、KVO引起的崩溃</strong></h3><h4 id="4-1、场景对应的Code"><a href="#4-1、场景对应的Code" class="headerlink" title="4.1、场景对应的Code"></a><strong>4.1、场景对应的Code</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;KvoCrashVC.h&quot;</span><br><span class="line"></span><br><span class="line">@interface KvoCrashVCObj : NSObject</span><br><span class="line">@property (nonatomic, strong) NSString *name;</span><br><span class="line">@end</span><br><span class="line">@implementation KvoCrashVCObj</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@interface KvoCrashVC ()</span><br><span class="line">@property (nonatomic, strong) KvoCrashVCObj *sObj;</span><br><span class="line">@end</span><br><span class="line">@implementation KvoCrashVC</span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    self.sObj = [[KvoCrashVCObj alloc] init];</span><br><span class="line">//#import &lt;XXShield/XXShield.h&gt;</span><br><span class="line">//    static dispatch_once_t onceToken;</span><br><span class="line">//    dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">//        [XXShieldSDK registerStabilityWithAbility:(EXXShieldTypeKVO)];</span><br><span class="line">//    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event &#123;</span><br><span class="line">    [self func4];</span><br><span class="line">&#125;</span><br><span class="line">/**</span><br><span class="line"> 观察者是局部变量，会崩溃</span><br><span class="line"> */</span><br><span class="line">- (void)func1 &#123;</span><br><span class="line">    // 崩溃日志：An -observeValueForKeyPath:ofObject:change:context: message was received but not handled.</span><br><span class="line">    KvoCrashVCObj* obj = [[KvoCrashVCObj alloc] init];</span><br><span class="line">    [self addObserver:obj</span><br><span class="line">           forKeyPath:@&quot;view&quot;</span><br><span class="line">              options:NSKeyValueObservingOptionNew</span><br><span class="line">              context:nil];</span><br><span class="line">    self.view = [[UIView alloc] init];</span><br><span class="line">&#125;</span><br><span class="line">/**</span><br><span class="line"> 被观察者是局部变量，会崩溃</span><br><span class="line"> */</span><br><span class="line">- (void)func2 &#123;</span><br><span class="line">    // 崩溃日志：An -observeValueForKeyPath:ofObject:change:context: message was received but not handled.</span><br><span class="line">    KvoCrashVCObj* obj = [[KvoCrashVCObj alloc] init];</span><br><span class="line">    [obj addObserver:self</span><br><span class="line">          forKeyPath:@&quot;name&quot;</span><br><span class="line">             options:NSKeyValueObservingOptionNew</span><br><span class="line">             context:nil];</span><br><span class="line">    obj.name = @&quot;&quot;;</span><br><span class="line">&#125;</span><br><span class="line">/**</span><br><span class="line"> 没有实现observeValueForKeyPath:ofObject:changecontext:方法:，会崩溃</span><br><span class="line"> */</span><br><span class="line">- (void)func3 &#123;</span><br><span class="line">    // 崩溃日志：An -observeValueForKeyPath:ofObject:change:context: message was received but not handled.</span><br><span class="line">    [self.sObj addObserver:self forKeyPath:@&quot;name&quot; options:NSKeyValueObservingOptionNew context:NULL];</span><br><span class="line">    self.sObj.name = @&quot;0&quot;;</span><br><span class="line">&#125;</span><br><span class="line">/**</span><br><span class="line"> 重复移除观察者，会崩溃</span><br><span class="line"> */</span><br><span class="line">- (void)func4 &#123;</span><br><span class="line">    // 崩溃日志：because it is not registered as an observer</span><br><span class="line">    [self.sObj addObserver:self forKeyPath:@&quot;name&quot; options:NSKeyValueObservingOptionNew context:NULL];</span><br><span class="line">    self.sObj.name = @&quot;0&quot;;</span><br><span class="line">    [self.sObj removeObserver:self forKeyPath:@&quot;name&quot;];</span><br><span class="line">    [self.sObj removeObserver:self forKeyPath:@&quot;name&quot;];</span><br><span class="line">&#125;</span><br><span class="line">/**</span><br><span class="line"> 重复添加观察者，不会崩溃，但是添加多少次，一次改变就会被观察多少次</span><br><span class="line"> */</span><br><span class="line">- (void)func5 &#123;</span><br><span class="line">    [self.sObj addObserver:self forKeyPath:@&quot;name&quot; options:NSKeyValueObservingOptionNew context:NULL];</span><br><span class="line">    self.sObj.name = @&quot;0&quot;;</span><br><span class="line">&#125;</span><br><span class="line">- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary&lt;NSKeyValueChangeKey,id&gt; *)change context:(void *)context &#123;</span><br><span class="line">    NSLog(@&quot;keyPath = %@&quot;, keyPath);</span><br><span class="line">&#125;</span><br><span class="line">// 总结：KVO有两种崩溃</span><br><span class="line">// 1、because it is not registered as an observer</span><br><span class="line">// 2、An -observeValueForKeyPath:ofObject:change:context: message was received but not handled.</span><br><span class="line">@end</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="4-2、原因"><a href="#4-2、原因" class="headerlink" title="4.2、原因"></a><strong>4.2、原因</strong></h4><blockquote>
<p>添加了观察者，没有在正确的时机移除</p>
</blockquote>
<h4 id="4-3、解决方案："><a href="#4-3、解决方案：" class="headerlink" title="4.3、解决方案："></a><strong>4.3、解决方案：</strong></h4><p>1、addObserver和removeObserver一定要成对出现，</p>
<p>2、推荐使用FaceBook开源的第三方库 <a href="https://link.juejin.im/?target=https://github.com/facebook/KVOController">FBKVOController</a></p>
<h3 id="5、集合类相关崩溃"><a href="#5、集合类相关崩溃" class="headerlink" title="5、集合类相关崩溃"></a><strong>5、集合类相关崩溃</strong></h3><h4 id="5-1、场景对应的Code"><a href="#5-1、场景对应的Code" class="headerlink" title="5.1、场景对应的Code"></a><strong>5.1、场景对应的Code</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;CollectionCrashVC.h&quot;</span><br><span class="line"></span><br><span class="line">@interface CollectionCrashVC ()</span><br><span class="line">@end</span><br><span class="line">@implementation CollectionCrashVC</span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    [self case4];</span><br><span class="line">&#125;</span><br><span class="line">/**</span><br><span class="line"> 场景一：数组越界</span><br><span class="line"> */</span><br><span class="line">- (void)case1 &#123;</span><br><span class="line">    // reason: &#x27;*** -[__NSArrayI objectAtIndex:]: index 4 beyond bounds [0 .. 2]&#x27;</span><br><span class="line">    NSArray* array = [[NSArray alloc]initWithObjects:@1, @2, @3, nil];</span><br><span class="line">    NSNumber* number = [array objectAtIndex:4];</span><br><span class="line">    NSLog(@&quot;number = %@&quot;, number);</span><br><span class="line">&#125;</span><br><span class="line">/**</span><br><span class="line"> 场景二：向数组中添加nil元素</span><br><span class="line"> */</span><br><span class="line">- (void)case2 &#123;</span><br><span class="line">    // reason: &#x27;*** -[__NSArrayM insertObject:atIndex:]: object cannot be nil&#x27;</span><br><span class="line">    NSMutableArray* array = [[NSMutableArray alloc]initWithObjects:@1, @2, @3, nil];</span><br><span class="line">    [array addObject:nil];</span><br><span class="line">&#125;</span><br><span class="line">/**</span><br><span class="line"> 场景三：数组遍历的时候使用错误的方式移除元素</span><br><span class="line"> */</span><br><span class="line">- (void)case3 &#123;</span><br><span class="line">    NSMutableArray&lt;NSNumber*&gt;* array = [NSMutableArray array];</span><br><span class="line">    [array addObject:@1];</span><br><span class="line">    [array addObject:@2];</span><br><span class="line">    [array addObject:@3];</span><br><span class="line">    [array addObject:@4];</span><br><span class="line">    // 不崩溃</span><br><span class="line">    [array enumerateObjectsUsingBlock:^(NSNumber * _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) &#123;</span><br><span class="line">        if (obj.integerValue == 1) &#123;</span><br><span class="line">            [array removeObject:obj];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    // 崩溃，reason: &#x27;*** Collection &lt;__NSArrayM: 0x2829946f0&gt; was mutated while being enumerated.&#x27;</span><br><span class="line">    for (NSNumber* obj in array) &#123;</span><br><span class="line">        if (obj.integerValue == 2) &#123;</span><br><span class="line">            [array removeObject:obj];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //    dispatch_async(dispatch_get_global_queue(0, 0), ^&#123;</span><br><span class="line">    //        self.view.backgroundColor = [UIColor blueColor];</span><br><span class="line">    //    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">/**</span><br><span class="line"> 场景四：使用setObject:forKey:向字典中添加value为nil的键值对，推荐使用KVC的setValue:nil forKey:</span><br><span class="line"> */</span><br><span class="line">- (void)case4 &#123;</span><br><span class="line">    NSMutableDictionary* dictionary = [NSMutableDictionary dictionary];</span><br><span class="line">    [dictionary setObject:@1 forKey:@1];</span><br><span class="line">    // 不崩溃：value为nil，只会移除key对应的键值对</span><br><span class="line">    [dictionary setValue:nil forKey:@1];</span><br><span class="line">    // 崩溃：reason: &#x27;*** -[__NSDictionaryM setObject:forKey:]: object cannot be nil (key: 1)&#x27;</span><br><span class="line">    [dictionary setObject:nil forKey:@1];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="5-2、原因"><a href="#5-2、原因" class="headerlink" title="5.2、原因"></a><strong>5.2、原因</strong></h4><blockquote>
<p>越界、添加nil、多线程非原子性操作、遍历的同时移除元素</p>
</blockquote>
<h4 id="5-3、场景："><a href="#5-3、场景：" class="headerlink" title="5.3、场景："></a><strong>5.3、场景：</strong></h4><ul>
<li>1、数组越界，访问下标大于数组的个数</li>
<li>2、向数组中添加空数据</li>
<li>3、多线程环境中，一个线程在读取，一个线程在移除</li>
<li>4、一边遍历数组，一边移除数组中的元素</li>
<li>5、多线程中操作可变数组（数组的扩容、访问僵尸对象）</li>
</ul>
<h4 id="5-4、解决方案："><a href="#5-4、解决方案：" class="headerlink" title="5.4、解决方案："></a><strong>5.4、解决方案：</strong></h4><ul>
<li>1、给集合类添加<code>category</code>重写原来的方法，在内部做判断</li>
<li>2、使用<code>Runtime</code>把原来的方法替换成自定义的安全方法</li>
<li>3、给<code>NSMutableDictionary</code>添加元素的时候，使用<code>setObject:forKey:</code>向字典中添加value为nil的键值对，推荐使用KVC的<code>setValue:nil forKey:</code>。<code>[mutableDictionary setValue:nil ForKey:@&quot;name&quot;]</code>不会崩溃，只是从字典中移除name键值对。</li>
<li>4、因为<code>NSMutableArray、NSMutableDictionary</code>不是线程安全的，所以在多线程环境下要保证读写操作的原子性，使用 <strong>加锁</strong> 、<strong>信号量</strong> 、<strong>GCD串行队列</strong> 、<strong>GCD栅栏</strong><code>dispatch_barrier_async</code>、<strong>CGD组</strong>的<code>dispatch_group_enter</code>和<code>dispatch_group_leave</code></li>
</ul>
<h3 id="6、多线程中的崩溃"><a href="#6、多线程中的崩溃" class="headerlink" title="6、多线程中的崩溃"></a><strong>6、多线程中的崩溃</strong></h3><h4 id="6-1、场景对应的Code"><a href="#6-1、场景对应的Code" class="headerlink" title="6.1、场景对应的Code"></a><strong>6.1、场景对应的Code</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#import &quot;ThreadCrashVC.h&quot;</span><br><span class="line"></span><br><span class="line">@interface ThreadCrashVC ()</span><br><span class="line">@property (nonatomic, strong) NSMutableArray *array;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation ThreadCrashVC</span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">&#125;</span><br><span class="line">- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event &#123;</span><br><span class="line">    [self case1];</span><br><span class="line">&#125;</span><br><span class="line">/**</span><br><span class="line"> dispatch_group_leave比dispatch_group_enter执行的次数多</span><br><span class="line"> */</span><br><span class="line">- (void)case1 &#123;</span><br><span class="line">    // 崩溃：Thread 1: EXC_BREAKPOINT (code=1, subcode=0x1054f6348)</span><br><span class="line">    dispatch_group_t group = dispatch_group_create();</span><br><span class="line">    dispatch_group_leave(group);</span><br><span class="line">&#125;</span><br><span class="line">/**</span><br><span class="line"> 在子线程更新UI</span><br><span class="line"> */</span><br><span class="line">- (void)case2 &#123;</span><br><span class="line">    dispatch_async(dispatch_get_global_queue(0, 0), ^&#123;</span><br><span class="line">        self.view.backgroundColor = [UIColor redColor];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">/**</span><br><span class="line"> 多个线程同时释放一个对象</span><br><span class="line"> */</span><br><span class="line">- (void)case3 &#123;   </span><br><span class="line">    // ==================使用信号量同步后不崩溃==================</span><br><span class="line">    &#123;</span><br><span class="line">        dispatch_semaphore_t semaphore = dispatch_semaphore_create(1);</span><br><span class="line">        __block NSObject *obj = [NSObject new];</span><br><span class="line">        dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, 0), ^&#123;</span><br><span class="line">            while (YES) &#123;</span><br><span class="line">                dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">                obj = [NSObject new];</span><br><span class="line">                dispatch_semaphore_signal(semaphore);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        while (YES) &#123;</span><br><span class="line">            dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">            obj = [NSObject new];</span><br><span class="line">            dispatch_semaphore_signal(semaphore);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // ==================未同步则崩溃==================</span><br><span class="line">    &#123;</span><br><span class="line">        __block NSObject *obj = [NSObject new];</span><br><span class="line">        dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, 0), ^&#123;</span><br><span class="line">            while (YES) &#123;</span><br><span class="line">                obj = [NSObject new];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        while (YES) &#123;</span><br><span class="line">            obj = [NSObject new];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">/**</span><br><span class="line"> 多线程中的数组扩容、浅复制</span><br><span class="line"> 扩容：数组的地址已经改变，报错was mutated while being enumerated</span><br><span class="line"> 浅复制：访问僵尸对象，报错EXC_BAD_ACCESS</span><br><span class="line"></span><br><span class="line"> // 知识点：集合类对象和非集合类对象的copy与mutableCopy</span><br><span class="line"> // [NSArray copy]                  // 浅复制</span><br><span class="line"> // [NSArray mutableCopy]           // 深复制</span><br><span class="line"> // [NSMutableArray copy]           // 深复制</span><br><span class="line"> // [NSMutableArray mutableCopy]    // 深复制</span><br><span class="line"></span><br><span class="line"> 参考：</span><br><span class="line"> [Swift数组扩容原理](https://bestswifter.com/swiftarrayappend/)</span><br><span class="line"> [戴仓薯](https://juejin.im/post/5a9aa633518825556a71d9f3)</span><br><span class="line"> */</span><br><span class="line">-(void)case4 &#123;</span><br><span class="line">    &#123;</span><br><span class="line">        NSArray *array = @[@[@&quot;a&quot;, @&quot;b&quot;], @[@&quot;c&quot;, @&quot;d&quot;]];</span><br><span class="line">        NSArray *copyArray = [array copy];</span><br><span class="line">        NSMutableArray *mCopyArray = [array mutableCopy];</span><br><span class="line">        NSLog(@&quot;array = %p，copyArray = %p，mCopyArray = %p&quot;, array, copyArray, mCopyArray);</span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">        NSMutableArray *array = [NSMutableArray arrayWithObjects:[NSMutableString stringWithString:@&quot;a&quot;],@&quot;b&quot;,@&quot;c&quot;,nil];</span><br><span class="line">        NSArray *copyArray = [array copy];</span><br><span class="line">        NSMutableArray *mCopyArray = [array mutableCopy];</span><br><span class="line">        NSLog(@&quot;array = %p，copyArray = %p，mCopyArray = %p&quot;, array, copyArray, mCopyArray);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dispatch_queue_t queue1 = dispatch_queue_create(&quot;queue1&quot;, 0);</span><br><span class="line">    dispatch_queue_t queue2 = dispatch_queue_create(&quot;queue2&quot;, 0);</span><br><span class="line"></span><br><span class="line">    NSMutableArray* array = [NSMutableArray array];</span><br><span class="line"></span><br><span class="line">    dispatch_async(queue1, ^&#123;</span><br><span class="line">        while (true) &#123;</span><br><span class="line">            if (array.count &lt; 10) &#123;</span><br><span class="line">                [array addObject:@(array.count)];</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                [array removeAllObjects];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    dispatch_async(queue2, ^&#123;</span><br><span class="line">        while (true) &#123;</span><br><span class="line">            // case 1：数组扩容</span><br><span class="line">            for (NSNumber* number in array) &#123;</span><br><span class="line">              NSLog(@&quot;%@&quot;, number);</span><br><span class="line">            &#125;</span><br><span class="line">            // case 2：数组扩容</span><br><span class="line">            NSArray* immutableArray = array;</span><br><span class="line">            for (NSNumber* number in immutableArray) &#123;</span><br><span class="line">              NSLog(@&quot;%@&quot;, number);</span><br><span class="line">            &#125;</span><br><span class="line">            // case 3：浅复制 在 [NSArray copy] 的过程，</span><br><span class="line">            // copy 方法内部调用initWithArray:range:copyItems: 时</span><br><span class="line">            // 数组被另一个线程清空，range 不一致导致抛出 exception</span><br><span class="line">            NSArray* immutableArray1 = [array copy];</span><br><span class="line">            for (NSNumber* number in immutableArray1) &#123;</span><br><span class="line">                NSLog(@&quot;%@&quot;, number);</span><br><span class="line">            &#125;</span><br><span class="line">            // case 4：浅复制 数组内的对象被其他线程释放，访问僵尸对象</span><br><span class="line">            NSArray* immutableArray2 = [array mutableCopy];</span><br><span class="line">            for (NSNumber* number in immutableArray2) &#123;</span><br><span class="line">                NSLog(@&quot;%@&quot;, number);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="6-2、原因"><a href="#6-2、原因" class="headerlink" title="6.2、原因"></a><strong>6.2、原因</strong></h4><blockquote>
<p>死锁、子线程中更新UI、多个线程同时释放一个对象</p>
</blockquote>
<h4 id="6-3、场景"><a href="#6-3、场景" class="headerlink" title="6.3、场景"></a><strong>6.3、场景</strong></h4><p>1、在子线程中更新UI</p>
<p>2、<strong>dispatch_group</strong> crash，<code>dispatch_group_leave</code>的次数比<code>dispatch_group_enter</code>次数多。</p>
<p>参考：<a href="https://link.juejin.im/?target=https://satanwoo.github.io/2017/01/07/DispatchGroupCrash/">iOS疑难问题排查之深入探究dispatch_group crash</a></p>
<p>3、多线程下非线程安全类的使用，如<code>NSMutableArray</code>、<code>NSMutableDictionary</code>。NSCache是线程安全的。</p>
<p>4、数据缓存到磁盘和读取。</p>
<h4 id="6-4、解决方案："><a href="#6-4、解决方案：" class="headerlink" title="6.4、解决方案："></a><strong>6.4、解决方案：</strong></h4><p>多线程遇到需要同步的时候，加锁，添加信号量等进行同步操作。一般多线程发生的Crash，会收到SIGSEGV信号，表明试图访问未分配给自己的内存, 或试图往没有写权限的内存地址写数据。</p>
<h3 id="7、Socket长连接，进入后台没有关闭"><a href="#7、Socket长连接，进入后台没有关闭" class="headerlink" title="7、Socket长连接，进入后台没有关闭"></a><strong>7、Socket长连接，进入后台没有关闭</strong></h3><blockquote>
<p>当服务器close一个连接时，若client端接着发数据。根据TCP协议的规定，会收到一个RST响应，client再往这个服务器发送数据时，系统会发出一个SIGPIPE信号给进程，告诉进程这个连接已经断开了，不要再写了。而根据信号的默认处理规则，SIGPIPE信号的默认执行动作是terminate(终止、退出),所以client会退出。</p>
</blockquote>
<p>长连接socket或重定向管道进入后台，没有关闭导致崩溃的解决办法：</p>
<h4 id="7-1、解决方案："><a href="#7-1、解决方案：" class="headerlink" title="7.1、解决方案："></a><strong>7.1、解决方案：</strong></h4><ul>
<li>方法一：1、切换到后台是，关闭长连接和管道，回到前台重新创建。</li>
<li>方法二：2、使用signal(SIGPIPE,SIG_IGN)，将SIGPIP交给系统处理，这么做将SIGPIPE设为SIG_IGN，使客户端不执行默认操作，即不退出。</li>
</ul>
<h3 id="8、Watch-Dog超时造成的crash"><a href="#8、Watch-Dog超时造成的crash" class="headerlink" title="8、Watch Dog超时造成的crash"></a><strong>8、Watch Dog超时造成的crash</strong></h3><blockquote>
<p>主线程执行耗时操作，导致主线程被卡超过一定时间。一般异常编码是0x8badf00d，表示应用发生watch dog超时而被iOS终止，通常是应用花费太多的时间无法启动、终止或者响应系统事件。</p>
</blockquote>
<h4 id="8-1、解决方案："><a href="#8-1、解决方案：" class="headerlink" title="8.1、解决方案："></a><strong>8.1、解决方案：</strong></h4><blockquote>
<p>主线程只负责更新UI和事件响应，将耗时操作（网络请求、数据库读写等）异步放到后台线程执行。</p>
</blockquote>
<h3 id="9、后台返回NSNull导致的崩溃，多见于Java做后台服务器开发语言"><a href="#9、后台返回NSNull导致的崩溃，多见于Java做后台服务器开发语言" class="headerlink" title="9、后台返回NSNull导致的崩溃，多见于Java做后台服务器开发语言"></a><strong>9、后台返回NSNull导致的崩溃，多见于Java做后台服务器开发语言</strong></h3><h4 id="9-1、场景对应的Code"><a href="#9-1、场景对应的Code" class="headerlink" title="9.1、场景对应的Code"></a><strong>9.1、场景对应的Code</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// reason: &#x27;-[NSNull integerValue]: unrecognized selector sent to instance 0x2098f99b0&#x27;</span><br><span class="line">NSNull *nullStr = [[NSNull alloc] init];</span><br><span class="line">NSMutableDictionary* dic = [NSMutableDictionary dictionary];</span><br><span class="line">[dic setValue:nullStr forKey:@&quot;key&quot;];</span><br><span class="line">NSNumber* number = [dic valueForKey:@&quot;key&quot;];</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><code>NULL</code>：用于普通类型，例如<code>NSInteger</code></li>
<li><code>nil</code>：用于OC对象（除了类这个对象）,给nil对象发送消息不会crash</li>
<li><code>Nil</code>：用于Class类型对象的赋值（类是元类的实例，也是对象）</li>
<li><code>NSNull</code>：用于OC对象的站位，一般会作为集合中的占位元素，给NSNull对象发送消息会crash的，后台给我们返回的就是NSNull对象</li>
</ul>
<h4 id="9-2、解决方法"><a href="#9-2、解决方法" class="headerlink" title="9.2、解决方法"></a><strong>9.2、解决方法</strong></h4><blockquote>
<p>利用消息转发。参考：<a href="https://link.juejin.im/?target=https://github.com/nicklockwood/NullSafe">NullSafe</a>。当我们给一个NSNull对象发送消息的话，可能会崩溃（null是有内存的），而发送给nil的话，是不会崩溃的。</p>
</blockquote>
<h3 id="10、在iOS中捕获异常信息"><a href="#10、在iOS中捕获异常信息" class="headerlink" title="10、在iOS中捕获异常信息"></a><strong>10、在iOS中捕获异常信息</strong></h3><blockquote>
<p>崩溃主要是由于 <code>Mach` 异常、`Objective-C` 异常（`NSException`）引起的，同时对于 </code>Mach<code> 异常，到了 ```BSD</code> 层会转换为对应的 <code>Signal` 信号，那么我们也可以通过捕获信号，来捕获 </code>Crash<code> 事件。针对 ```NSException</code> 可以通过注册 &#96;&#96;&#96;NSUncaughtExceptionHandler&#96; 捕获异常信息。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> 一、OC异常处理函数</span><br><span class="line"></span><br><span class="line"> @param exception exception</span><br><span class="line"> */</span><br><span class="line">static void uncaught_exception_handler (NSException *exception) &#123;</span><br><span class="line">    // 异常的堆栈信息</span><br><span class="line">    NSArray *stackArray = [exception callStackSymbols];</span><br><span class="line">    // 出现异常的原因</span><br><span class="line">    NSString *reason = [exception reason];</span><br><span class="line">    // 异常名称</span><br><span class="line">    NSString *name = [exception name];</span><br><span class="line">    NSString *exceptionInfo = [NSString stringWithFormat:@&quot;Exception reason：%@\nException name：%@\nException stack：%@&quot;,</span><br><span class="line">                               name,</span><br><span class="line">                               reason,</span><br><span class="line">                               stackArray];</span><br><span class="line">    NSLog(@&quot;%@&quot;, exceptionInfo);</span><br><span class="line">    NSMutableArray *tmpArr = [NSMutableArray arrayWithArray:stackArray];</span><br><span class="line">    [tmpArr insertObject:reason atIndex:0];</span><br><span class="line">    //保存到本地  --  当然你可以在下次启动的时候，上传这个log</span><br><span class="line">    [exceptionInfo writeToFile:[NSString stringWithFormat:@&quot;%@/Documents/error.log&quot;,NSHomeDirectory()]</span><br><span class="line">                    atomically:YES</span><br><span class="line">                      encoding:NSUTF8StringEncoding</span><br><span class="line">                         error:nil];</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     *  把异常崩溃信息发送至开发者邮件</span><br><span class="line">     */</span><br><span class="line">    NSString *content = [NSString stringWithFormat:@&quot;==异常错误报告==\nname:%@\nreason:\n%@\ncallStackSymbols:\n%@&quot;,</span><br><span class="line">                         name,</span><br><span class="line">                         reason,</span><br><span class="line">                         [stackArray componentsJoinedByString:@&quot;\n&quot;]];</span><br><span class="line">    NSMutableString *mailUrl = [NSMutableString string];</span><br><span class="line">    [mailUrl appendString:@&quot;mailto:test@qq.com&quot;];</span><br><span class="line">    [mailUrl appendString:@&quot;?subject=程序异常崩溃，请配合发送异常报告，谢谢合作！&quot;];</span><br><span class="line">    [mailUrl appendFormat:@&quot;&amp;body=%@&quot;, content];</span><br><span class="line">    // 打开地址</span><br><span class="line">    NSCharacterSet *set = [NSCharacterSet URLHostAllowedCharacterSet];</span><br><span class="line">    NSString *mailPath = [mailUrl stringByAddingPercentEncodingWithAllowedCharacters:set];</span><br><span class="line">    //NSString *mailPath = [mailUrl stringByAddingPercentEscapesUsingEncoding:NSUTF8StringEncoding];</span><br><span class="line">    [[UIApplication sharedApplication] openURL:[NSURL URLWithString:mailPath]];</span><br><span class="line">&#125;</span><br><span class="line">/**</span><br><span class="line"> 二、Unix标准的signal机制处理函数</span><br><span class="line"></span><br><span class="line"> @param sig sig</span><br><span class="line"> */</span><br><span class="line">static void handleSignal( int sig ) &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions &#123;</span><br><span class="line">    // OC层中未被捕获的异常，通过注册NSUncaughtExceptionHandler捕获异常信息</span><br><span class="line">    NSSetUncaughtExceptionHandler(&amp;uncaught_exception_handler);</span><br><span class="line">    // 内存访问错误，重复释放等错误就无能为力了，因为这种错误它抛出的是Signal，所以必须要专门做Signal处理</span><br><span class="line">    // OC中层不能转换的Mach异常，利用Unix标准的signal机制，注册SIGABRT, SIGBUS, SIGSEGV等信号发生时的处理函数。</span><br><span class="line">    signal(SIGSEGV,handleSignal);</span><br><span class="line">    return YES;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div>
        </div>
        
            <div class="kratos-copyright text-center clearfix">
                <h5 itemprop="copyrightNotice">本作品采用 <a rel="license nofollow" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">知识共享署名-相同方式共享 4.0 国际许可协议</a> 进行许可</h5>
            </div>
        
        <footer class="kratos-entry-footer clearfix">
            
                <div class="post-like-donate text-center clearfix" id="post-like-donate">
                
                
                    <a class="share" href="javascript:;"><i class="fa fa-share-alt"></i> 分享</a>
                    <div class="share-wrap" style="display: none;">
    <div class="share-group">
        <a href="javascript:;" class="share-plain qq" onclick="share('qq');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-qq"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain qzone" onclick="share('qzone');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-star"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain weixin pop style-plain" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-weixin"></i>
            </div>
            <div class="share-int">
                <div class="qrcode" id="wechat-qr"></div>
                <p>打开微信“扫一扫”，打开网页后点击屏幕右上角分享按钮</p>
            </div>
        </a>
        <a href="javascript:;" class="share-plain weibo" onclick="share('weibo');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-weibo"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain facebook style-plain" onclick="share('facebook');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-facebook"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain twitter style-plain" onclick="share('twitter');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-twitter"></i>
            </div>
        </a>
    </div>
    <script type="text/javascript">
        $(()=>{
            new QRCode("wechat-qr", {
                text: "http://example.com/17/iOS-%E4%B8%AD%E5%B8%B8%E8%A7%81-Crash-%E6%80%BB%E7%BB%93/",
                width: 150,
                height: 150,
                correctLevel : QRCode.CorrectLevel.H
            });
        });
        function share(dest) {
            const qqBase        = "https://connect.qq.com/widget/shareqq/index.html?";
            const weiboBase     = "https://service.weibo.com/share/share.php?";
            const qzoneBase     = "https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?";
            const facebookBase  = "https://www.facebook.com/sharer/sharer.php?";
            const twitterBase   = "https://twitter.com/intent/tweet?";
            const hostUrl       = "http://example.com/17/iOS-%E4%B8%AD%E5%B8%B8%E8%A7%81-Crash-%E6%80%BB%E7%BB%93/";
            const title         = "「iOS 中常见 Crash 总结」";
            const excerpt       = `
1、找不到方法的实现unrecognized selector sent to instance
2、KVC造成的crash
3、EXC_BAD_ACCESS
4、KVO引起的崩溃
5、集合类相关崩溃
6、多线程中的崩溃
7、Soc...`;
            let _URL;
            switch (dest) {
                case "qq"       : _URL = qqBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";     break;
                case "weibo"    : _URL = weiboBase+"url="+hostUrl+"&title="+title+excerpt;                                 break;
                case "qzone"    : _URL = qzoneBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";  break;
                case "facebook" : _URL = facebookBase+"u="+hostUrl;                                                        break;
                case "twitter"  : _URL = twitterBase+"text="+title+excerpt+"&url="+hostUrl;                                break;
            }
            window.open(_URL);
        };
    </script>
</div>
                
                </div>
            
            <div class="footer-tag clearfix">
                <div class="pull-left">
                <i class="fa fa-tags"></i>
                    
                </div>
				
            </div>
        </footer>
    </div>
    
        <nav class="navigation post-navigation clearfix" role="navigation">
            
            <div class="nav-previous clearfix">
                <a title=" runtime(三)：基本使用场景" href="/08/runtime-三-：基本使用场景/">&lt; 上一篇</a>
            </div>
            
            
            <div class="nav-next clearfix">
                <a title=" iOS 消息推送" href="/16/iOS-消息推送/">下一篇 &gt;</a>
            </div>
            
        </nav>
    
    
</article>

        

            </section>

        

                
            

<section id="kratos-widget-area" class="col-md-4 hidden-xs hidden-sm">
    <!-- 文章和页面根据splitter来分割，没有的话就从头开始设置为sticky -->
    
    
                <aside id="krw-about" class="widget widget-kratos-about clearfix">
    <div class="photo-background"></div>
    <div class="photo-wrapper clearfix">
        <div class="photo-wrapper-tip text-center">
            <img class="about-photo" src="/images/avatar.webp" loading="lazy" decoding="auto" />
        </div>
    </div>
    <div class="textwidget">
        <p class="text-center"></p>
    </div>
    <div class="site-meta">
        <a class="meta-item" href="/archives/">
            <span class="title">
                文章
            </span>
            <span class="count">
                102
            </span>
        </a>
        <a class="meta-item" href="/categories/">
            <span class="title">
                分类
            </span>
            <span class="count">
                8
            </span>
        </a>
        <a class="meta-item" href="/tags/">
            <span class="title">
                标签
            </span>
            <span class="count">
                12
            </span>
        </a>
    </div>
</aside>
            
                    <div class="sticky-area">
                
                
  <aside id="krw-categories" class="widget widget-kratos-categories clearfix">
    <h4 class="widget-title"><i class="fa fa-folder"></i>分类目录</h4>
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Flutter/">Flutter</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Hexo/">Hexo</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS%E7%9F%A5%E8%AF%86%E7%82%B9/">iOS知识点</a><span class="category-list-count">60</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%8A%A0%E5%AF%86%E6%8A%80%E6%9C%AF/">加密技术</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/">开发工具</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9F%B3%E8%A7%86%E9%A2%91%E7%9B%B8%E5%85%B3/">音视频相关</a><span class="category-list-count">10</span></li></ul>
  </aside>


            
                
  <aside id="krw-tags" class="widget widget-kratos-tags clearfix">
    <h4 class="widget-title"><i class="fa fa-tags"></i>标签聚合</h4>
      <div class="tag-clouds">
        <a href="/tags/Cocoapods/" style="font-size: 0.63em;">Cocoapods</a> <a href="/tags/Runloop/" style="font-size: 0.6em;">Runloop</a> <a href="/tags/Swift/" style="font-size: 0.71em;">Swift</a> <a href="/tags/UI%E6%8E%A7%E4%BB%B6/" style="font-size: 0.8em;">UI控件</a> <a href="/tags/ffmpeg/" style="font-size: 0.77em;">ffmpeg</a> <a href="/tags/git/" style="font-size: 0.63em;">git</a> <a href="/tags/runtime/" style="font-size: 0.66em;">runtime</a> <a href="/tags/%E5%8A%A0%E5%AF%86/" style="font-size: 0.6em;">加密</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 0.66em;">多线程</a> <a href="/tags/%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/" style="font-size: 0.74em;">底层原理</a> <a href="/tags/%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/" style="font-size: 0.69em;">开源框架</a> <a href="/tags/%E6%99%BA%E8%83%BD%E8%AE%BE%E5%A4%87/" style="font-size: 0.63em;">智能设备</a>
      </div>
  </aside>

            
                
  <aside id="krw-posts" class="widget widget-kratos-posts">
  <h4 class="widget-title"><i class="fa fa-file"></i>最新文章</h4>
  <div class="tab-content">
      <ul class="list-group">
        
        
          
          
            <a class="list-group-item" href="/11/%E8%87%AA%E5%90%AF%E5%8A%A8%E5%AF%BC%E8%87%B4%E4%B8%8A%E6%9E%B6%E8%A2%AB%E6%89%93%E5%9B%9E%E7%9A%84%E5%A4%84%E7%90%86/"><i class="fa  fa-book"></i> 自启动导致上架被打回的处理</a>
            
          
        
          
          
            <a class="list-group-item" href="/20/%E4%BD%BF%E7%94%A8FFmpeg%E5%BA%93%E5%AF%B9%E9%9F%B3%E9%A2%91%E8%BF%9B%E8%A1%8C%E7%BC%96%E7%A0%81/"><i class="fa  fa-book"></i> 使用FFmpeg库对音频进行编码</a>
            
          
        
          
          
            <a class="list-group-item" href="/09/%E4%BD%BF%E7%94%A8FFmpeg%E5%BA%93%E5%AF%B9%E8%A7%86%E9%A2%91%E8%BF%9B%E8%A1%8C%E7%BC%96%E7%A0%81/"><i class="fa  fa-book"></i> 使用FFmpeg库对视频进行编码</a>
            
          
        
          
          
            <a class="list-group-item" href="/10/%E4%BD%BF%E7%94%A8FFmpeg%E5%BA%93%E5%AF%B9%E8%A7%86%E9%A2%91%E8%B5%84%E6%BA%90%E8%BF%9B%E8%A1%8C%E6%A0%BC%E5%BC%8F%E8%BD%AC%E6%8D%A2/"><i class="fa  fa-book"></i> 使用FFmpeg库对视频资源进行格式转换</a>
            
          
        
          
          
            <a class="list-group-item" href="/17/XCode14-iOS16-%E9%80%82%E9%85%8D%E9%97%AE%E9%A2%98/"><i class="fa  fa-book"></i> XCode14 & iOS16 适配问题</a>
            
          
        
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
      </ul>
  </div>
  </aside>

            
    </div>
</section>
        
        </div>
    </div>
</div>
<footer>
    <div id="footer"  class="ap-lrc"  >
        <div class="container">
            <div class="row">
                <div class="col-md-6 col-md-offset-3 footer-list text-center">
                    <ul class="kratos-social-icons">
                        
                        
                        <li><a target="_blank" rel="nofollow" href="https://t.me/CandyUnion"><i class="fa fa-telegram"></i></a></li>
                        
                        
                        
                        <li><a target="_blank" rel="me" href="https://nya.one/@Candinya"><i class="fa fa fa-share-alt-square"></i></a></li>
                        <li><a target="_blank" rel="nofollow" href="https://github.com/Candinya"><i class="fa fa-github"></i></a></li>
                        
                    </ul>
                    <ul class="kratos-copyright">
                        <div>
                            <li>&copy; 2023 欢迎来到我的个人博客 版权所有.</li>
                            
                        </div>
                    </ul>
                </div>
            </div>
        </div>
        <div class="kr-tool text-center">
            <div class="tool">
                
                    <div class="box search-box">
                        <a href="/search/">
                            <span class="fa fa-search"></span>
                        </a>
                    </div>
                
                
                    <div class="box theme-box" id="darkmode-switch">
                        <span class="fa fa-adjust"></span>
                    </div>
                
                
            </div>
            <div class="box gotop-box">
                <span class="fa fa-chevron-up"></span>
            </div>
        </div>
    </div>
</footer>
</div>
</div>

        <script defer src="/vendors/bootstrap@3.3.4/dist/js/bootstrap.min.js"></script>
<script defer src="/vendors/nprogress@0.2.0/nprogress.js"></script>
<script>
    if (!window.kr) {
        window.kr = {};
    }
    window.kr.notMobile = (!(navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)));
    window.kr.siteRoot = "/";
</script>


    <script async src="/js/candy.min.js"></script>



    <script defer src="/vendors/aplayer@1.10.1/dist/APlayer.min.js"></script>
    
    <script defer src="/vendors/meting@2.0.1/dist/Meting.min.js"></script>
    <meting-js
        server="netease"
        type="playlist"
        id="3204190542"
        order="random"
        fixed="true"
    >
    </meting-js>



    <script defer src="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

<script defer src="/vendors/clipboard@2.0.6/dist/clipboard.min.js"></script>
<script defer src="/js/kratosr.min.js"></script>
<script defer src="/js/pjax.min.js"></script>



<!-- Extra support for third-party plguins  -->


    </body>
</html>